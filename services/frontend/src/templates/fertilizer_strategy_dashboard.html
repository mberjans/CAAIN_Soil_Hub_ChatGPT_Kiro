<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - AFAS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .agricultural-card {
            border-left: 4px solid #28a745;
            transition: transform 0.2s;
        }
        .agricultural-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        .metric-card {
            border-radius: 12px;
            padding: 1.5rem;
            color: #fff;
            position: relative;
            overflow: hidden;
        }
        .metric-card::after {
            content: "";
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            right: -40px;
            top: -40px;
            opacity: 0.15;
            background: rgba(255, 255, 255, 0.6);
        }
        .metric-card h5 {
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.06rem;
        }
        .metric-card .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        .metric-card .metric-trend {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        .chart-container {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            height: 100%;
        }
        .alert-card {
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            background: rgba(40, 167, 69, 0.08);
            margin-bottom: 1rem;
        }
        .alert-card h6 {
            margin-bottom: 0.5rem;
        }
        .status-badge {
            font-size: 0.8rem;
            border-radius: 999px;
            padding: 0.25rem 0.75rem;
        }
        .price-row {
            border-bottom: 1px solid #f1f3f5;
            padding: 0.75rem 0;
        }
        .price-row:last-child {
            border-bottom: none;
        }
        .price-indicator {
            font-weight: 600;
        }
        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #198754;
        }
        .real-time-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: #198754;
            position: relative;
        }
        .real-time-dot::after {
            content: "";
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid rgba(25, 135, 84, 0.4);
            top: -6px;
            left: -6px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.7;
            }
            70% {
                transform: scale(1.2);
                opacity: 0;
            }
            100% {
                transform: scale(0.95);
                opacity: 0;
            }
        }
        .optimization-card {
            border-radius: 12px;
            padding: 1.5rem;
            background: linear-gradient(135deg, #e9f7ef, #d1f0dc);
            border: 1px solid rgba(40, 167, 69, 0.35);
            height: 100%;
        }
        .recommendation-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed rgba(40, 167, 69, 0.3);
        }
        .recommendation-item:last-child {
            border-bottom: none;
        }
        .summary-table tr td:first-child {
            font-weight: 600;
            color: #495057;
        }
        .summary-table tr td {
            padding: 0.4rem 0;
            vertical-align: middle;
        }
        .performance-legend span {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            margin-right: 0.75rem;
            font-size: 0.85rem;
        }
        .performance-legend span::before {
            content: "";
            width: 12px;
            height: 12px;
            border-radius: 3px;
            display: inline-block;
        }
        .legend-profit::before { background: #198754; }
        .legend-cost::before { background: #ffc107; }
        .legend-impact::before { background: #20c997; }
        .trend-positive {
            color: #0f5132;
        }
        .trend-negative {
            color: #842029;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-seedling"></i> AFAS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/fertilizer-strategy">Strategy Optimizer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/fertilizer-strategy-dashboard">Strategy Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/fertilizer-application">Application Planner</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="mb-1"><i class="fas fa-chart-line text-success"></i> Fertilizer Strategy Dashboard</h1>
                <p class="text-muted mb-0">Monitor optimization performance, costs, and environmental impact in real time.</p>
            </div>
            <div class="text-end">
                <div class="real-time-indicator">
                    <span class="real-time-dot"></span>
                    <span id="lastUpdatedLabel">Live</span>
                </div>
                <button id="refreshDashboardBtn" class="btn btn-outline-success btn-sm ms-2">
                    <i class="fas fa-sync-alt"></i> Refresh Now
                </button>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="metric-card" style="background: linear-gradient(135deg, #198754, #28a745);">
                    <h5>Total Program ROI</h5>
                    <div class="metric-value" id="roiValue">--%</div>
                    <div class="metric-trend" id="roiTrend"></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="metric-card" style="background: linear-gradient(135deg, #0d6efd, #0b5ed7);">
                    <h5>Annual Input Cost</h5>
                    <div class="metric-value" id="costValue">$--</div>
                    <div class="metric-trend" id="costTrend"></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="metric-card" style="background: linear-gradient(135deg, #20c997, #0ca678);">
                    <h5>Yield Projection</h5>
                    <div class="metric-value" id="yieldValue">-- bu/ac</div>
                    <div class="metric-trend" id="yieldTrend"></div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="metric-card" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                    <h5>Impact Score</h5>
                    <div class="metric-value" id="impactValue">--</div>
                    <div class="metric-trend" id="impactTrend"></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-5">
                <div class="optimization-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0"><i class="fas fa-sliders-h text-success"></i> Optimization Snapshot</h5>
                        <span class="status-badge bg-success text-white" id="optimizationStatus">Optimal</span>
                    </div>
                    <p class="text-muted mb-3">Current recommendation vs economic optimum calculated using soil tests and market pricing.</p>
                    <table class="table table-borderless summary-table mb-3">
                        <tbody id="summaryTableBody">
                        </tbody>
                    </table>
                    <div>
                        <h6 class="text-success mb-2">Priority Actions</h6>
                        <div id="recommendationsList"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="chart-container h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-chart-area text-success"></i> ROI and Cost Trend</h5>
                        <div class="performance-legend">
                            <span class="legend-profit">ROI</span>
                            <span class="legend-cost">Cost</span>
                            <span class="legend-impact">Impact</span>
                        </div>
                    </div>
                    <canvas id="performanceTrendChart" height="220"></canvas>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-xl-4 col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-balance-scale text-success"></i> Nutrient Cost Distribution</h5>
                    <canvas id="costBreakdownChart" height="220"></canvas>
                </div>
            </div>
            <div class="col-xl-4 col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-seedling text-success"></i> Yield Contribution</h5>
                    <canvas id="yieldContributionChart" height="220"></canvas>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-leaf text-success"></i> Sustainability Indicators</h5>
                        <span class="badge bg-success" id="sustainabilityRating">Strong</span>
                    </div>
                    <ul class="list-unstyled mb-0" id="sustainabilityList">
                    </ul>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-dollar-sign text-success"></i> Market Price Monitor</h5>
                        <span class="text-muted" id="priceRefreshLabel">Updating...</span>
                    </div>
                    <div id="priceRows"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-bell text-success"></i> Alerts & Notifications</h5>
                    <div id="alertsContainer"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-stream text-success"></i> Strategy Activity Log</h5>
                    <div class="list-group" id="activityLog">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dashboardState = {
            charts: {},
            isRefreshing: false,
            lastUpdated: null
        };

        const sampleDashboardData = {
            roi: { value: 18.4, trend: 2.6 },
            cost: { value: 48250, trend: -3.4 },
            yield: { value: 196, trend: 3.1 },
            impact: { value: 8.6, trend: 0.8 },
            optimization: {
                status: "Optimal",
                summary: [
                    { label: "Recommended Nitrogen Rate", value: "175 lbs/ac", detail: "Split application (V4 + V10)" },
                    { label: "Phosphorus Strategy", value: "Maintenance (35 lbs/ac)", detail: "Build-up deferred to next season" },
                    { label: "Potassium Program", value: "Supplemental (40 lbs/ac)", detail: "Targeted to low-testing zones" },
                    { label: "Estimated Total Cost", value: "$48,250", detail: "Blended fertilizer pricing active" },
                    { label: "Projected Net Profit", value: "$139,200", detail: "Based on $5.10/bu corn" }
                ],
                recommendations: [
                    { action: "Schedule sidedress nitrogen for next moisture window", priority: "High" },
                    { action: "Monitor DAP pricing - smaller lots trending downward", priority: "Medium" },
                    { action: "Validate yield monitor calibration before harvest", priority: "High" }
                ]
            },
            charts: {
                performance: [
                    { month: "Apr", roi: 12, cost: 51000, impact: 7.4 },
                    { month: "May", roi: 14, cost: 50500, impact: 7.9 },
                    { month: "Jun", roi: 15.6, cost: 50000, impact: 8.1 },
                    { month: "Jul", roi: 17.2, cost: 49500, impact: 8.3 },
                    { month: "Aug", roi: 18.4, cost: 48250, impact: 8.6 }
                ],
                costBreakdown: [
                    { nutrient: "Nitrogen", value: 58 },
                    { nutrient: "Phosphorus", value: 24 },
                    { nutrient: "Potassium", value: 14 },
                    { nutrient: "Sulfur", value: 4 }
                ],
                yieldContribution: [
                    { program: "N Timing Optimization", value: 38 },
                    { program: "Soil Health Practices", value: 22 },
                    { program: "Micro-Nutrient Support", value: 16 },
                    { program: "In-Season Monitoring", value: 24 }
                ],
                sustainability: [
                    { label: "Nutrient Efficiency", value: "92%", detail: "On track with NRCS guidelines" },
                    { label: "Runoff Risk", value: "Low", detail: "Buffer zones & cover crop adoption" },
                    { label: "Soil Health Score", value: "8.3 / 10", detail: "Maintaining organic matter gains" },
                    { label: "Carbon Intensity", value: "-0.8%", detail: "Year-over-year reduction" }
                ]
            },
            prices: [
                { product: "Urea (46-0-0)", region: "Midwest", price: 468, change: -8, unit: "$/ton" },
                { product: "DAP (18-46-0)", region: "Midwest", price: 612, change: -4, unit: "$/ton" },
                { product: "Potash (0-0-60)", region: "Midwest", price: 415, change: 6, unit: "$/ton" },
                { product: "AMS (21-0-0-24S)", region: "Midwest", price: 365, change: 0, unit: "$/ton" }
            ],
            alerts: [
                {
                    title: "Nitrogen sidedress window approaching",
                    detail: "Forecast shows favorable conditions in 3 days. Confirm equipment readiness.",
                    severity: "high",
                    timestamp: "Today, 08:15"
                },
                {
                    title: "DAP inventory surplus reported",
                    detail: "Regional dealers signal potential price drop within 10-14 days.",
                    severity: "medium",
                    timestamp: "Yesterday, 17:40"
                },
                {
                    title: "Monitor field 12B for K uptake",
                    detail: "Tissue tests indicated marginal potassium levels last season.",
                    severity: "medium",
                    timestamp: "Yesterday, 09:05"
                }
            ],
            activityLog: [
                {
                    title: "Strategy re-optimized with latest soil tests",
                    detail: "Adjusted phosphorus maintenance rate and recalibrated ROI forecast.",
                    timestamp: "Aug 24, 07:20"
                },
                {
                    title: "Imported fertilizer price feed",
                    detail: "Automated update from USDA NASS and dealer network.",
                    timestamp: "Aug 23, 18:05"
                },
                {
                    title: "Environmental compliance check passed",
                    detail: "Runoff risk assessment aligned with state watershed guidelines.",
                    timestamp: "Aug 22, 14:12"
                }
            ]
        };

        document.addEventListener("DOMContentLoaded", function () {
            initializeDashboard(sampleDashboardData);
            attachRefreshHandler();
            startAutoRefresh();
        });

        function attachRefreshHandler() {
            const refreshButton = document.getElementById("refreshDashboardBtn");
            refreshButton.addEventListener("click", function () {
                if (dashboardState.isRefreshing) {
                    return;
                }
                refreshDashboardData();
            });
        }

        function startAutoRefresh() {
            window.setInterval(function () {
                refreshDashboardData();
            }, 60000);
        }

        function refreshDashboardData() {
            dashboardState.isRefreshing = true;
            setRefreshLabel("Refreshing...");

            fetch("/api/v1/prices/fertilizer-current")
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("Price service unavailable");
                    }
                    return response.json();
                })
                .then(function (remoteData) {
                    const mergedData = mergeRemoteData(remoteData);
                    initializeDashboard(mergedData);
                    markRefreshSuccess();
                })
                .catch(function (error) {
                    console.warn("Dashboard refresh fallback:", error.message);
                    initializeDashboard(sampleDashboardData);
                    setRefreshLabel("Live data unavailable - showing scenario data");
                })
                .finally(function () {
                    dashboardState.isRefreshing = false;
                });
        }

        function mergeRemoteData(remoteData) {
            const merged = JSON.parse(JSON.stringify(sampleDashboardData));
            if (remoteData && Array.isArray(remoteData.prices)) {
                merged.prices = remoteData.prices.map(function (item) {
                    return {
                        product: item.fertilizer_type || item.product || "Fertilizer",
                        region: item.region || "Region",
                        price: item.price_per_unit || item.price || 0,
                        change: item.trend_7d || 0,
                        unit: item.unit || "$/ton"
                    };
                });
            }
            return merged;
        }

        function initializeDashboard(data) {
            updateHeadlineMetrics(data);
            populateOptimizationSummary(data.optimization);
            renderPerformanceChart(data.charts.performance);
            renderCostBreakdownChart(data.charts.costBreakdown);
            renderYieldContributionChart(data.charts.yieldContribution);
            populateSustainability(data.charts.sustainability);
            populatePriceRows(data.prices);
            populateAlerts(data.alerts);
            populateActivityLog(data.activityLog);
            setLastUpdated();
        }

        function updateHeadlineMetrics(data) {
            document.getElementById("roiValue").textContent = data.roi.value.toFixed(1) + "%";
            setTrendText("roiTrend", data.roi.trend);

            document.getElementById("costValue").textContent = "$" + formatNumber(data.cost.value);
            setTrendText("costTrend", data.cost.trend);

            document.getElementById("yieldValue").textContent = data.yield.value.toFixed(0) + " bu/ac";
            setTrendText("yieldTrend", data.yield.trend);

            document.getElementById("impactValue").textContent = data.impact.value.toFixed(1);
            setTrendText("impactTrend", data.impact.trend);
        }

        function setTrendText(elementId, trendValue) {
            const target = document.getElementById(elementId);
            const isPositive = trendValue >= 0;
            const icon = isPositive ? "fa-arrow-up" : "fa-arrow-down";
            const css = isPositive ? "trend-positive" : "trend-negative";
            const indicator = isPositive ? "+" : "";
            target.innerHTML = "<i class='fas " + icon + "'></i> <span class='" + css + "'>" + indicator + trendValue.toFixed(1) + "% vs last month</span>";
        }

        function populateOptimizationSummary(optimization) {
            document.getElementById("optimizationStatus").textContent = optimization.status;
            const summaryBody = document.getElementById("summaryTableBody");
            summaryBody.innerHTML = "";

            optimization.summary.forEach(function (row) {
                const tr = document.createElement("tr");
                const labelCell = document.createElement("td");
                labelCell.textContent = row.label;
                const valueCell = document.createElement("td");
                valueCell.innerHTML = "<strong>" + row.value + "</strong><div class='text-muted small'>" + row.detail + "</div>";
                tr.appendChild(labelCell);
                tr.appendChild(valueCell);
                summaryBody.appendChild(tr);
            });

            const recommendationList = document.getElementById("recommendationsList");
            recommendationList.innerHTML = "";
            optimization.recommendations.forEach(function (item) {
                const div = document.createElement("div");
                div.className = "recommendation-item";
                div.innerHTML = "<span>" + item.action + "</span><span class='badge bg-success-subtle text-success'>" + item.priority + "</span>";
                recommendationList.appendChild(div);
            });
        }

        function renderPerformanceChart(chartData) {
            const ctx = document.getElementById("performanceTrendChart").getContext("2d");
            const labels = chartData.map(function (item) { return item.month; });
            const roiValues = chartData.map(function (item) { return item.roi; });
            const costValues = chartData.map(function (item) { return item.cost; });
            const impactValues = chartData.map(function (item) { return item.impact; });

            if (dashboardState.charts.performance) {
                dashboardState.charts.performance.destroy();
            }

            dashboardState.charts.performance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "ROI",
                            data: roiValues,
                            yAxisID: "y",
                            borderColor: "#198754",
                            backgroundColor: "rgba(25, 135, 84, 0.15)",
                            tension: 0.35,
                            borderWidth: 3,
                            fill: true
                        },
                        {
                            label: "Input Cost",
                            data: costValues,
                            yAxisID: "y1",
                            borderColor: "#ffc107",
                            backgroundColor: "rgba(255, 193, 7, 0.1)",
                            tension: 0.35,
                            borderWidth: 3,
                            fill: false
                        },
                        {
                            label: "Environmental Impact",
                            data: impactValues,
                            yAxisID: "y",
                            borderColor: "#20c997",
                            backgroundColor: "rgba(32, 201, 151, 0.1)",
                            tension: 0.35,
                            borderWidth: 3,
                            borderDash: [6, 6],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: "index", intersect: false },
                    scales: {
                        y: {
                            type: "linear",
                            position: "left",
                            beginAtZero: false,
                            title: { display: true, text: "ROI / Impact" }
                        },
                        y1: {
                            type: "linear",
                            position: "right",
                            beginAtZero: false,
                            title: { display: true, text: "Cost ($)" },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function renderCostBreakdownChart(data) {
            const ctx = document.getElementById("costBreakdownChart").getContext("2d");
            const labels = data.map(function (item) { return item.nutrient; });
            const values = data.map(function (item) { return item.value; });

            if (dashboardState.charts.costBreakdown) {
                dashboardState.charts.costBreakdown.destroy();
            }

            dashboardState.charts.costBreakdown = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ["#198754", "#0d6efd", "#ffc107", "#6f42c1"],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: "60%",
                    plugins: {
                        legend: { position: "bottom" }
                    }
                }
            });
        }

        function renderYieldContributionChart(data) {
            const ctx = document.getElementById("yieldContributionChart").getContext("2d");
            const labels = data.map(function (item) { return item.program; });
            const values = data.map(function (item) { return item.value; });

            if (dashboardState.charts.yieldContribution) {
                dashboardState.charts.yieldContribution.destroy();
            }

            dashboardState.charts.yieldContribution = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Yield Contribution (%)",
                        data: values,
                        backgroundColor: "rgba(13, 110, 253, 0.6)",
                        borderColor: "#0d6efd",
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 50,
                            ticks: { stepSize: 10 }
                        }
                    }
                }
            });
        }

        function populateSustainability(items) {
            const list = document.getElementById("sustainabilityList");
            list.innerHTML = "";

            items.forEach(function (item) {
                const li = document.createElement("li");
                li.className = "mb-3";
                li.innerHTML = "<div class='d-flex justify-content-between align-items-center'>" +
                    "<div><strong>" + item.label + "</strong><div class='text-muted small'>" + item.detail + "</div></div>" +
                    "<span class='badge bg-success-subtle text-success'>" + item.value + "</span>" +
                    "</div>";
                list.appendChild(li);
            });
        }

        function populatePriceRows(prices) {
            const container = document.getElementById("priceRows");
            container.innerHTML = "";

            prices.forEach(function (price) {
                const row = document.createElement("div");
                row.className = "price-row";

                const changeClass = price.change >= 0 ? "text-danger" : "text-success";
                const changeIcon = price.change >= 0 ? "fa-arrow-up" : "fa-arrow-down";
                const changeValue = Math.abs(price.change);

                row.innerHTML = "<div class='d-flex justify-content-between align-items-center'>" +
                    "<div>" +
                    "<h6 class='mb-0'>" + price.product + "</h6>" +
                    "<small class='text-muted'>" + price.region + "</small>" +
                    "</div>" +
                    "<div class='text-end'>" +
                    "<div class='price-indicator'>$" + price.price + " <small class='text-muted'>" + price.unit + "</small></div>" +
                    "<div class='" + changeClass + " small'><i class='fas " + changeIcon + "'></i> " + changeValue + " (" + (price.change >= 0 ? "+" : "-") + " weekly)</div>" +
                    "</div>" +
                    "</div>";

                container.appendChild(row);
            });
        }

        function populateAlerts(alerts) {
            const container = document.getElementById("alertsContainer");
            container.innerHTML = "";

            if (!alerts || alerts.length === 0) {
                container.innerHTML = "<div class='alert alert-secondary'>No active alerts.</div>";
                return;
            }

            alerts.forEach(function (alert) {
                const card = document.createElement("div");
                card.className = "alert-card";
                const badgeClass = alert.severity === "high" ? "bg-danger" : "bg-warning";
                const severityLabel = alert.severity === "high" ? "High Priority" : "Medium Priority";
                card.innerHTML = "<div class='d-flex justify-content-between align-items-center mb-1'>" +
                    "<h6 class='mb-0'>" + alert.title + "</h6>" +
                    "<span class='badge " + badgeClass + "'>" + severityLabel + "</span>" +
                    "</div>" +
                    "<p class='mb-2 text-muted'>" + alert.detail + "</p>" +
                    "<small class='text-secondary'>" + alert.timestamp + "</small>";
                container.appendChild(card);
            });
        }

        function populateActivityLog(entries) {
            const log = document.getElementById("activityLog");
            log.innerHTML = "";

            entries.forEach(function (entry) {
                const item = document.createElement("div");
                item.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-start";
                item.innerHTML = "<div class='ms-2 me-auto'><div class='fw-bold'>" + entry.title + "</div>" +
                    entry.detail + "</div><span class='badge bg-light text-muted'>" + entry.timestamp + "</span>";
                log.appendChild(item);
            });
        }

        function setLastUpdated() {
            dashboardState.lastUpdated = new Date();
            const label = document.getElementById("lastUpdatedLabel");
            label.textContent = "Updated " + dashboardState.lastUpdated.toLocaleTimeString();
            setRefreshLabel("Updated " + dashboardState.lastUpdated.toLocaleTimeString());
        }

        function setRefreshLabel(text) {
            document.getElementById("priceRefreshLabel").textContent = text;
        }

        function markRefreshSuccess() {
            setRefreshLabel("Live data refreshed");
        }

        function formatNumber(value) {
            return value.toLocaleString("en-US", { maximumFractionDigits: 0 });
        }
    </script>
</body>
</html>
