<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Rotation Planning - AFAS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .agricultural-card {
            border-left: 4px solid #28a745;
            transition: transform 0.2s;
        }
        .agricultural-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .field-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .field-card.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8, #f8fff8);
        }
        .field-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .rotation-timeline {
            display: flex;
            overflow-x: auto;
            padding: 20px 0;
            margin: 20px 0;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .rotation-year {
            min-width: 200px;
            margin: 0 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .rotation-year.current {
            border-color: #28a745;
            background: #e8f5e8;
        }
        .crop-selection {
            margin-top: 10px;
        }
        .crop-option {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .crop-option.selected {
            background: #28a745;
            color: white;
        }
        .crop-option:hover {
            background: #6c757d;
            color: white;
        }
        
        /* Drag and Drop Styles */
        .rotation-year.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .rotation-year.drag-over {
            border: 2px dashed #007bff;
            background: #e3f2fd;
        }
        .drag-handle {
            cursor: grab;
            padding: 5px;
            color: #6c757d;
            user-select: none;
        }
        .drag-handle:hover {
            color: #007bff;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        
        /* Advanced Year Management */
        .year-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
        }
        .rotation-year:hover .year-controls {
            display: block;
        }
        .year-btn {
            background: rgba(255,255,255,0.9);
            border: 1px solid #dee2e6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 2px;
            cursor: pointer;
            font-size: 10px;
        }
        .year-btn:hover {
            background: #007bff;
            color: white;
        }
        
        /* Crop Substitution Panel */
        .substitution-panel {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            padding: 10px;
        }
        .substitution-panel.show {
            display: block;
        }
        .substitution-crop {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .substitution-crop:hover {
            background: #007bff;
            color: white;
        }
        .substitution-crop.recommended {
            background: #28a745;
            color: white;
        }
        
        /* Constraint Validation Indicators */
        .constraint-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .constraint-valid { background: #28a745; }
        .constraint-warning { background: #ffc107; }
        .constraint-error { background: #dc3545; }
        
        /* Undo/Redo Controls */
        .history-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 5px;
            display: flex;
            gap: 5px;
        }
        .history-btn {
            background: none;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            color: #6c757d;
            font-size: 14px;
        }
        .history-btn:hover:not(:disabled) {
            background: #e9ecef;
            color: #495057;
        }
        .history-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Template Selector */
        .template-selector {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .template-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .template-card:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }
        .template-card.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        /* Conflict Resolution Modal */
        .conflict-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
        }
        .conflict-resolution {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 8px;
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .plan-metrics {
            background: linear-gradient(135deg, #e3f2fd, #ffffff);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .metric-item:last-child {
            border-bottom: none;
        }
        .metric-value {
            font-weight: bold;
            color: #28a745;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .comparison-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .scenario-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .benefit-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .benefit-high { background-color: #28a745; }
        .benefit-medium { background-color: #ffc107; }
        .benefit-low { background-color: #dc3545; }
        
        /* Modification Tools Styles */
        .modification-toolbar {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .drag-handle {
            cursor: grab;
            color: #6c757d;
            font-size: 1.2em;
            padding: 5px;
        }
        .drag-handle:hover {
            color: #28a745;
        }
        .rotation-year.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .drop-zone {
            min-height: 60px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .drop-zone.active {
            border-color: #28a745;
            background-color: #e8f5e8;
        }
        .year-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: none;
        }
        .rotation-year:hover .year-controls {
            display: block;
        }
        .constraint-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .suggestion-card {
            background: #e3f2fd;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .modification-history {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
        }
        .history-item {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9em;
        }
        .rotation-template {
            cursor: pointer;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 5px;
            transition: all 0.2s;
        }
        .rotation-template:hover {
            border-color: #28a745;
            background-color: #f8fff8;
        }
        .validation-status {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-valid { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-invalid { background-color: #dc3545; }
        
        /* Rotation Impact Visualization Styles */
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        
        .chart-container h6 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .chart-container canvas {
            max-width: 100%;
            height: auto !important;
        }
        
        #visualizationSection .card-header {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        #visualizationSection .card-body {
            background: #f8f9fa;
        }
        
        .chart-container:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-seedling"></i> AFAS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/crop-selection">Crop Selection</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/rotation-planning">Rotation Planning</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/goal-prioritization">Goal Prioritization</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status"></div>
            <p>Processing rotation plan...</p>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1><i class="fas fa-sync-alt"></i> Crop Rotation Planning</h1>
                <p class="lead">Design and optimize multi-year crop rotation plans for your fields</p>
            </div>
        </div>
        
        <!-- Field Management Section -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card agricultural-card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-map-marked-alt"></i> Field Management</h5>
                        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#newFieldModal">
                            <i class="fas fa-plus"></i> Add Field
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="fieldsList">
                            <!-- Fields will be dynamically loaded -->
                        </div>
                        
                        <!-- Field Details Form -->
                        <div id="fieldDetailsForm" style="display: none;">
                            <h6>Field Details</h6>
                            <form id="fieldForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Field Name</label>
                                        <input type="text" class="form-control" id="fieldName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Size (acres)</label>
                                        <input type="number" class="form-control" id="fieldSize" step="0.1" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Soil Type</label>
                                        <select class="form-control" id="soilType">
                                            <option value="">Select soil type</option>
                                            <option value="clay">Clay</option>
                                            <option value="loam">Loam</option>
                                            <option value="sandy">Sandy</option>
                                            <option value="silty">Silty</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Drainage Class</label>
                                        <select class="form-control" id="drainageClass">
                                            <option value="">Select drainage class</option>
                                            <option value="well_drained">Well Drained</option>
                                            <option value="moderately_drained">Moderately Drained</option>
                                            <option value="poorly_drained">Poorly Drained</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="irrigationAvailable">
                                            <label class="form-check-label" for="irrigationAvailable">
                                                Irrigation Available
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="col-lg-4">
                <div class="card agricultural-card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-tools"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="generateRotationPlan()">
                            <i class="fas fa-magic"></i> Generate Rotation Plan
                        </button>
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="compareScenarios()">
                            <i class="fas fa-balance-scale"></i> Compare Scenarios
                        </button>
                        <button class="btn btn-outline-warning w-100 mb-2" onclick="analyzeBenefits()">
                            <i class="fas fa-chart-line"></i> Analyze Benefits
                        </button>
                        <button class="btn btn-outline-info w-100" onclick="economicAnalysis()">
                            <i class="fas fa-calculator"></i> Economic Analysis
                        </button>
                    </div>
                </div>
                
                <!-- Selected Field Info -->
                <div class="card agricultural-card" id="selectedFieldInfo" style="display: none;">
                    <div class="card-header bg-secondary text-white">
                        <h5><i class="fas fa-info-circle"></i> Selected Field</h5>
                    </div>
                    <div class="card-body" id="fieldInfoContent">
                        <!-- Field information will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rotation Timeline Section -->
        <div class="row" id="rotationSection" style="display: none;">
            <div class="col-12">
                <div class="card agricultural-card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-calendar-alt"></i> Rotation Timeline</h5>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="addYear()">
                                <i class="fas fa-plus"></i> Add Year
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="optimizeRotation()">
                                <i class="fas fa-cogs"></i> Optimize
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showTemplates()">
                                <i class="fas fa-layer-group"></i> Templates
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="showConflictResolution()">
                                <i class="fas fa-exclamation-triangle"></i> Resolve Issues
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="position: relative;">
                        <!-- History Controls -->
                        <div class="history-controls" id="historyControls">
                            <button class="history-btn" id="undoBtn" onclick="undoAction()" disabled title="Undo">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="history-btn" id="redoBtn" onclick="redoAction()" disabled title="Redo">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        
                        <!-- Template Selector -->
                        <div class="template-selector" id="templateSelector" style="display: none;">
                            <h6><i class="fas fa-layer-group"></i> Rotation Templates</h6>
                            <div id="templateList">
                                <!-- Templates will be populated here -->
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-primary btn-sm" onclick="applyTemplate()" id="applyTemplateBtn" disabled>
                                    Apply Template
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="hideTemplates()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                        
                        <div class="rotation-timeline" id="rotationTimeline">
                            <!-- Timeline will be dynamically populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Plan Metrics Section -->
        <div class="row" id="metricsSection" style="display: none;">
            <div class="col-md-6">
                <div class="plan-metrics">
                    <h5><i class="fas fa-chart-bar"></i> Plan Performance</h5>
                    <div class="metric-item">
                        <span>Soil Health Score</span>
                        <span class="metric-value" id="soilHealthScore">-</span>
                    </div>
                    <div class="metric-item">
                        <span>Profit Potential</span>
                        <span class="metric-value" id="profitPotential">-</span>
                    </div>
                    <div class="metric-item">
                        <span>Risk Level</span>
                        <span class="metric-value" id="riskLevel">-</span>
                    </div>
                    <div class="metric-item">
                        <span>Sustainability Score</span>
                        <span class="metric-value" id="sustainabilityScore">-</span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="plan-metrics">
                    <h5><i class="fas fa-exclamation-triangle"></i> Constraints & Warnings</h5>
                    <div id="constraintsWarnings">
                        <!-- Warnings will be dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rotation Impact Visualizations Section -->
        <div class="row" id="visualizationSection" style="display: none;">
            <div class="col-12">
                <div class="card agricultural-card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-chart-line"></i> Rotation Impact Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <h6>Soil Health Timeline</h6>
                                    <canvas id="soilHealthChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <h6>Economic Impact Over Time</h6>
                                    <canvas id="economicChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <h6>Crop Diversity Pattern</h6>
                                    <canvas id="diversityChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <h6>Sustainability Radar</h6>
                                    <canvas id="sustainabilityChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scenario Comparison Section -->
        <div class="row" id="comparisonSection" style="display: none;">
            <div class="col-12">
                <div class="card agricultural-card">
                    <div class="card-header bg-warning text-white">
                        <h5><i class="fas fa-balance-scale"></i> Scenario Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="comparison-table" id="comparisonTable">
                            <!-- Comparison results will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Field Modal -->
    <div class="modal fade" id="newFieldModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Field</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="newFieldForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Field Name *</label>
                                <input type="text" class="form-control" name="field_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Farm ID *</label>
                                <input type="text" class="form-control" name="farm_id" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Size (acres) *</label>
                                <input type="number" class="form-control" name="size_acres" step="0.1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Soil Type</label>
                                <select class="form-control" name="soil_type">
                                    <option value="">Select soil type</option>
                                    <option value="clay">Clay</option>
                                    <option value="loam">Loam</option>
                                    <option value="sandy">Sandy</option>
                                    <option value="silty">Silty</option>
                                    <option value="clayey_loam">Clayey Loam</option>
                                    <option value="sandy_loam">Sandy Loam</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Drainage Class</label>
                                <select class="form-control" name="drainage_class">
                                    <option value="">Select drainage class</option>
                                    <option value="well_drained">Well Drained</option>
                                    <option value="moderately_drained">Moderately Drained</option>
                                    <option value="poorly_drained">Poorly Drained</option>
                                    <option value="somewhat_poorly_drained">Somewhat Poorly Drained</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Slope (%)</label>
                                <input type="number" class="form-control" name="slope_percent" step="0.1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Climate Zone</label>
                                <input type="text" class="form-control" name="climate_zone" placeholder="e.g., 5a, 6b">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Elevation (ft)</label>
                                <input type="number" class="form-control" name="elevation_ft">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="irrigation_available" id="modalIrrigation">
                                    <label class="form-check-label" for="modalIrrigation">
                                        Irrigation Available
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Create Field</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Conflict Resolution Modal -->
    <div class="modal fade" id="conflictResolutionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Rotation Conflicts & Suggestions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="conflictsList">
                        <!-- Conflicts will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="applyConflictResolutions()">
                        Apply All Suggestions
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Crop Substitution Details Modal -->
    <div class="modal fade" id="cropSubstitutionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-exchange-alt"></i> Crop Substitution Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="substitutionDetails">
                        <!-- Substitution details will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="applySubstitution()">
                        Apply Substitution
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let currentFields = [];
        let selectedField = null;
        let currentRotationPlan = null;
        let availableCrops = [
            'Corn', 'Soybeans', 'Wheat', 'Oats', 'Barley', 'Rye',
            'Alfalfa', 'Clover', 'Cotton', 'Rice', 'Potatoes', 'Tomatoes',
            'Sunflower', 'Canola', 'Peas', 'Beans', 'Cover Crops'
        ];
        
        // Advanced rotation modification system
        let rotationHistory = [];
        let historyIndex = -1;
        let maxHistorySize = 50;
        let sortableInstance = null;
        let selectedTemplate = null;
        let currentConflicts = [];
        let cropDatabase = null;
        
        // Rotation templates
        const rotationTemplates = {
            'corn_soy_classic': {
                name: 'Corn-Soybean Classic',
                sequence: ['Corn', 'Soybeans'],
                description: 'Traditional 2-year corn-soybean rotation',
                benefits: ['Nitrogen fixation', 'Pest cycle break', 'Good economics'],
                suitable_regions: ['Midwest', 'Prairie regions']
            },
            'diversified_grain': {
                name: 'Diversified Grain',
                sequence: ['Corn', 'Soybeans', 'Wheat', 'Oats'],
                description: '4-year diversified grain rotation',
                benefits: ['High diversity', 'Risk reduction', 'Multiple income streams'],
                suitable_regions: ['Temperate regions', 'Northern plains']
            },
            'soil_building': {
                name: 'Soil Building Focus',
                sequence: ['Alfalfa', 'Alfalfa', 'Corn', 'Soybeans'],
                description: 'Rotation focused on soil health improvement',
                benefits: ['Soil structure', 'Nitrogen fixation', 'Organic matter'],
                suitable_regions: ['All regions with adequate moisture']
            },
            'cash_crop_intensive': {
                name: 'Cash Crop Intensive',
                sequence: ['Corn', 'Corn', 'Soybeans', 'Wheat'],
                description: 'High-value cash crop rotation',
                benefits: ['High profit potential', 'Market flexibility'],
                suitable_regions: ['High productivity soils', 'Good market access']
            },
            'sustainable_mixed': {
                name: 'Sustainable Mixed',
                sequence: ['Corn', 'Soybeans', 'Cover Crops', 'Wheat', 'Clover'],
                description: '5-year sustainable rotation with cover crops',
                benefits: ['Soil health', 'Biodiversity', 'Erosion control'],
                suitable_regions: ['All regions', 'Especially rolling terrain']
            }
        };
        
        // Crop compatibility and substitution data
        const cropCompatibility = {
            'Corn': {
                good_predecessors: ['Soybeans', 'Alfalfa', 'Clover', 'Cover Crops'],
                poor_predecessors: ['Corn'],
                substitutes: ['Grain Sorghum', 'Sunflower'],
                nitrogen_needs: 'high',
                pest_pressure: ['Corn Rootworm', 'European Corn Borer']
            },
            'Soybeans': {
                good_predecessors: ['Corn', 'Wheat', 'Oats'],
                poor_predecessors: ['Soybeans'],
                substitutes: ['Dry Beans', 'Peas'],
                nitrogen_needs: 'low',
                nitrogen_fixation: true,
                pest_pressure: ['Soybean Cyst Nematode', 'White Mold']
            },
            'Wheat': {
                good_predecessors: ['Soybeans', 'Corn'],
                poor_predecessors: ['Wheat', 'Barley'],
                substitutes: ['Barley', 'Rye', 'Triticale'],
                nitrogen_needs: 'medium',
                pest_pressure: ['Fusarium Head Blight', 'Stripe Rust']
            }
            // Add more crop data as needed
        };
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadFields();
            setupEventListeners();
            initializeCropDatabase();
            initializeRotationCharts();
        });
        
        function setupEventListeners() {
            // New field form submission
            document.getElementById('newFieldForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createNewField(this);
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'z':
                            if (e.shiftKey) {
                                e.preventDefault();
                                redoAction();
                            } else {
                                e.preventDefault();
                                undoAction();
                            }
                            break;
                        case 'y':
                            e.preventDefault();
                            redoAction();
                            break;
                    }
                }
            });
        }
        
        function initializeCropDatabase() {
            // Initialize crop database with detailed information
            cropDatabase = {
                getCropInfo: function(cropName) {
                    return cropCompatibility[cropName] || {
                        good_predecessors: [],
                        poor_predecessors: [],
                        substitutes: [],
                        nitrogen_needs: 'medium',
                        pest_pressure: []
                    };
                },
                
                getSubstitutions: function(cropName, context = {}) {
                    const cropInfo = this.getCropInfo(cropName);
                    const substitutes = [...cropInfo.substitutes];
                    
                    // Add intelligent substitutions based on context
                    if (context.soil_type === 'sandy' && cropName === 'Corn') {
                        substitutes.push('Potatoes', 'Carrots');
                    }
                    
                    return substitutes.filter(sub => availableCrops.includes(sub));
                },
                
                validateSequence: function(sequence) {
                    const issues = [];
                    
                    for (let i = 1; i < sequence.length; i++) {
                        const currentCrop = sequence[i];
                        const previousCrop = sequence[i - 1];
                        const cropInfo = this.getCropInfo(currentCrop);
                        
                        if (cropInfo.poor_predecessors.includes(previousCrop)) {
                            issues.push({
                                type: 'poor_sequence',
                                year: i + 1,
                                crop: currentCrop,
                                previous: previousCrop,
                                severity: 'warning',
                                message: `${currentCrop} following ${previousCrop} may reduce yield`
                            });
                        }
                        
                        // Check for consecutive same crops
                        if (currentCrop === previousCrop) {
                            issues.push({
                                type: 'monoculture',
                                year: i + 1,
                                crop: currentCrop,
                                severity: 'error',
                                message: `Consecutive ${currentCrop} increases pest and disease risk`
                            });
                        }
                    }
                    
                    // Check for diversity
                    const uniqueCrops = new Set(sequence);
                    if (uniqueCrops.size < sequence.length / 2) {
                        issues.push({
                            type: 'low_diversity',
                            severity: 'warning',
                            message: 'Low crop diversity may increase risks'
                        });
                    }
                    
                    return issues;
                }
            };
        }
        
        async function loadFields() {
            try {
                // For demo purposes, create some sample fields
                // In production, this would fetch from the API
                currentFields = [
                    {
                        field_id: 'field_demo_001',
                        field_name: 'North Field',
                        farm_id: 'demo_farm',
                        size_acres: 40.0,
                        soil_type: 'loam',
                        drainage_class: 'well_drained',
                        irrigation_available: true
                    },
                    {
                        field_id: 'field_demo_002', 
                        field_name: 'South Field',
                        farm_id: 'demo_farm',
                        size_acres: 25.5,
                        soil_type: 'clay',
                        drainage_class: 'moderately_drained',
                        irrigation_available: false
                    }
                ];
                
                displayFields();
            } catch (error) {
                console.error('Error loading fields:', error);
            }
        }
        
        function displayFields() {
            const fieldsContainer = document.getElementById('fieldsList');
            fieldsContainer.innerHTML = '';
            
            if (currentFields.length === 0) {
                fieldsContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                        <p>No fields added yet. Click "Add Field" to get started.</p>
                    </div>
                `;
                return;
            }
            
            currentFields.forEach(field => {
                const fieldCard = document.createElement('div');
                fieldCard.className = 'field-card';
                fieldCard.onclick = () => selectField(field);
                
                fieldCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${field.field_name}</h6>
                            <p class="text-muted small mb-1">
                                ${field.size_acres} acres • ${field.soil_type || 'Unknown soil'} • 
                                ${field.drainage_class || 'Unknown drainage'}
                            </p>
                            <div class="small">
                                ${field.irrigation_available ? '<span class="badge bg-primary"><i class="fas fa-tint"></i> Irrigated</span>' : ''}
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${field.field_id}</small>
                        </div>
                    </div>
                `;
                
                fieldsContainer.appendChild(fieldCard);
            });
        }
        
        function selectField(field) {
            // Update UI to show selected field
            document.querySelectorAll('.field-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            selectedField = field;
            
            // Show field info panel
            const infoPanel = document.getElementById('selectedFieldInfo');
            const infoContent = document.getElementById('fieldInfoContent');
            
            infoContent.innerHTML = `
                <h6>${field.field_name}</h6>
                <div class="row small">
                    <div class="col-6">
                        <strong>Size:</strong> ${field.size_acres} acres
                    </div>
                    <div class="col-6">
                        <strong>Farm:</strong> ${field.farm_id}
                    </div>
                    <div class="col-6">
                        <strong>Soil:</strong> ${field.soil_type || 'Unknown'}
                    </div>
                    <div class="col-6">
                        <strong>Drainage:</strong> ${field.drainage_class || 'Unknown'}
                    </div>
                    <div class="col-12 mt-2">
                        <strong>Irrigation:</strong> ${field.irrigation_available ? 'Available' : 'Not available'}
                    </div>
                </div>
            `;
            
            infoPanel.style.display = 'block';
        }
        
        async function createNewField(form) {
            const formData = new FormData(form);
            const fieldData = {
                field_name: formData.get('field_name'),
                farm_id: formData.get('farm_id'),
                size_acres: parseFloat(formData.get('size_acres')),
                soil_type: formData.get('soil_type'),
                drainage_class: formData.get('drainage_class'),
                slope_percent: formData.get('slope_percent') ? parseFloat(formData.get('slope_percent')) : null,
                irrigation_available: formData.has('irrigation_available'),
                climate_zone: formData.get('climate_zone'),
                elevation_ft: formData.get('elevation_ft') ? parseFloat(formData.get('elevation_ft')) : null
            };
            
            try {
                showLoading(true);
                
                const response = await fetch('/api/v1/rotations/fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(fieldData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Add the new field to current fields
                currentFields.push({
                    field_id: result.field_id,
                    field_name: fieldData.field_name,
                    farm_id: fieldData.farm_id,
                    size_acres: fieldData.size_acres,
                    soil_type: fieldData.soil_type,
                    drainage_class: fieldData.drainage_class,
                    irrigation_available: fieldData.irrigation_available
                });
                
                displayFields();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('newFieldModal'));
                modal.hide();
                form.reset();
                
                alert('Field created successfully!');
                
            } catch (error) {
                console.error('Error creating field:', error);
                alert('Error creating field. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        async function generateRotationPlan() {
            if (!selectedField) {
                alert('Please select a field first');
                return;
            }
            
            try {
                showLoading(true);
                
                // Demo rotation plan generation
                const demoRotation = generateDemoRotation(selectedField);
                displayRotationPlan(demoRotation);
                
                document.getElementById('rotationSection').style.display = 'block';
                document.getElementById('metricsSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error generating rotation plan:', error);
                alert('Error generating rotation plan. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        function generateDemoRotation(field) {
            // Generate a demo 4-year rotation plan
            const rotationOptions = [
                ['Corn', 'Soybeans', 'Wheat', 'Cover Crops'],
                ['Soybeans', 'Corn', 'Oats', 'Alfalfa'],
                ['Cotton', 'Wheat', 'Soybeans', 'Cover Crops'],
                ['Potatoes', 'Wheat', 'Clover', 'Corn']
            ];
            
            const selectedRotation = rotationOptions[Math.floor(Math.random() * rotationOptions.length)];
            const currentYear = new Date().getFullYear();
            
            return {
                plan_id: `plan_${field.field_id}_${Date.now()}`,
                field_id: field.field_id,
                rotation_sequence: selectedRotation.map((crop, index) => ({
                    year: currentYear + index,
                    crop: crop,
                    planting_date: getPlantingDate(crop),
                    harvest_date: getHarvestDate(crop)
                })),
                metrics: {
                    soil_health_score: (Math.random() * 40 + 60).toFixed(1),
                    profit_potential: '$' + (Math.random() * 300 + 400).toFixed(0) + '/acre',
                    risk_level: ['Low', 'Medium', 'High'][Math.floor(Math.random() * 3)],
                    sustainability_score: (Math.random() * 30 + 70).toFixed(1)
                }
            };
        }
        
        function getPlantingDate(crop) {
            const plantingDates = {
                'Corn': 'April 15',
                'Soybeans': 'May 1',
                'Wheat': 'October 15',
                'Cotton': 'April 20',
                'Oats': 'March 15',
                'Cover Crops': 'September 1',
                'Alfalfa': 'April 1',
                'Clover': 'April 10',
                'Potatoes': 'April 5'
            };
            return plantingDates[crop] || 'April 15';
        }
        
        function getHarvestDate(crop) {
            const harvestDates = {
                'Corn': 'October 15',
                'Soybeans': 'September 30',
                'Wheat': 'July 15',
                'Cotton': 'October 1',
                'Oats': 'July 20',
                'Cover Crops': 'May 15',
                'Alfalfa': 'Multiple cuts',
                'Clover': 'August 15',
                'Potatoes': 'September 1'
            };
            return harvestDates[crop] || 'September 15';
        }
        
        function displayRotationPlan(plan) {
            currentRotationPlan = plan;
            const timeline = document.getElementById('rotationTimeline');
            timeline.innerHTML = '';
            
            plan.rotation_sequence.forEach((yearData, index) => {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'rotation-year';
                yearDiv.draggable = true;
                yearDiv.dataset.yearIndex = index;
                if (index === 0) yearDiv.classList.add('current');
                
                // Validate this year's crop choice
                const sequence = plan.rotation_sequence.map(y => y.crop);
                const validation = validateCropInSequence(yearData.crop, index, sequence);
                
                yearDiv.innerHTML = `
                    <div class="drag-handle" title="Drag to reorder">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    
                    <div class="year-controls">
                        <span class="year-btn" onclick="insertYear(${index})" title="Insert year before">
                            <i class="fas fa-plus"></i>
                        </span>
                        ${plan.rotation_sequence.length > 2 ? `
                            <span class="year-btn" onclick="removeYear(${index})" title="Remove year">
                                <i class="fas fa-times"></i>
                            </span>
                        ` : ''}
                    </div>
                    
                    <div class="constraint-indicator constraint-${validation.status}" title="${validation.message}">
                        <i class="fas fa-${validation.status === 'valid' ? 'check' : validation.status === 'warning' ? 'exclamation' : 'times'}"></i>
                    </div>
                    
                    <h6>Year ${index + 1}</h6>
                    <div class="fw-bold">${yearData.year}</div>
                    
                    <div class="crop-selection mt-2" style="position: relative;">
                        <select class="form-control form-control-sm" onchange="updateCrop(${index}, this.value)" onfocus="showCropSubstitutions(${index}, this)">
                            ${availableCrops.map(crop => 
                                `<option value="${crop}" ${crop === yearData.crop ? 'selected' : ''}>${crop}</option>`
                            ).join('')}
                        </select>
                        
                        <div class="substitution-panel" id="substitution-${index}">
                            <div class="small mb-2"><strong>Recommended alternatives:</strong></div>
                            <div id="substitution-crops-${index}">
                                <!-- Substitution crops will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="small mt-2 text-muted">
                        <div>Plant: ${yearData.planting_date}</div>
                        <div>Harvest: ${yearData.harvest_date}</div>
                    </div>
                    
                    <div class="small mt-1">
                        <button class="btn btn-outline-info btn-sm" onclick="showCropDetails('${yearData.crop}', ${index})" style="font-size: 0.7em; padding: 2px 6px;">
                            Details
                        </button>
                    </div>
                `;
                
                timeline.appendChild(yearDiv);
            });
            
            // Initialize drag and drop
            initializeDragAndDrop();
            
            // Update metrics and validate entire rotation
            updateMetrics(plan.metrics);
            validateEntireRotation();
            
            // Save state to history
            saveToHistory('Display rotation plan');
        }
        
        function initializeDragAndDrop() {
            const timeline = document.getElementById('rotationTimeline');
            
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            
            sortableInstance = new Sortable(timeline, {
                animation: 150,
                ghostClass: 'rotation-year-ghost',
                dragClass: 'dragging',
                
                onStart: function(evt) {
                    evt.item.classList.add('dragging');
                },
                
                onEnd: function(evt) {
                    evt.item.classList.remove('dragging');
                    
                    if (evt.oldIndex !== evt.newIndex) {
                        // Reorder the rotation sequence
                        const item = currentRotationPlan.rotation_sequence.splice(evt.oldIndex, 1)[0];
                        currentRotationPlan.rotation_sequence.splice(evt.newIndex, 0, item);
                        
                        // Update year numbers
                        const currentYear = new Date().getFullYear();
                        currentRotationPlan.rotation_sequence.forEach((yearData, index) => {
                            yearData.year = currentYear + index;
                        });
                        
                        // Re-render the plan
                        displayRotationPlan(currentRotationPlan);
                        
                        saveToHistory(`Reordered year ${evt.oldIndex + 1} to position ${evt.newIndex + 1}`);
                    }
                }
            });
        }
        
        function validateCropInSequence(crop, index, sequence) {
            if (index === 0) return { status: 'valid', message: 'First year - no constraints' };
            
            const previousCrop = sequence[index - 1];
            const cropInfo = cropDatabase.getCropInfo(crop);
            
            if (crop === previousCrop) {
                return { status: 'error', message: 'Consecutive same crop increases risk' };
            }
            
            if (cropInfo.poor_predecessors.includes(previousCrop)) {
                return { status: 'warning', message: `${crop} may not perform well after ${previousCrop}` };
            }
            
            if (cropInfo.good_predecessors.includes(previousCrop)) {
                return { status: 'valid', message: `Good crop sequence: ${previousCrop} → ${crop}` };
            }
            
            return { status: 'valid', message: 'Acceptable crop sequence' };
        }
        
        function validateEntireRotation() {
            if (!currentRotationPlan) return;
            
            const sequence = currentRotationPlan.rotation_sequence.map(y => y.crop);
            const issues = cropDatabase.validateSequence(sequence);
            currentConflicts = issues;
            
            // Update UI to show overall validation status
            const constraintsDiv = document.getElementById('constraintsWarnings');
            let warningsHtml = '';
            
            if (issues.length === 0) {
                warningsHtml = `
                    <div class="d-flex align-items-center mb-2">
                        <span class="benefit-indicator benefit-high"></span>
                        No rotation conflicts detected
                    </div>
                `;
            } else {
                issues.forEach(issue => {
                    const iconClass = issue.severity === 'error' ? 'benefit-low' : 'benefit-medium';
                    warningsHtml += `
                        <div class="d-flex align-items-center mb-2">
                            <span class="benefit-indicator ${iconClass}"></span>
                            ${issue.message}
                        </div>
                    `;
                });
            }
            
            constraintsDiv.innerHTML = warningsHtml;
        }
        
        function updateMetrics(metrics) {
            document.getElementById('soilHealthScore').textContent = metrics.soil_health_score + '%';
            document.getElementById('profitPotential').textContent = metrics.profit_potential;
            document.getElementById('riskLevel').textContent = metrics.risk_level;
            document.getElementById('sustainabilityScore').textContent = metrics.sustainability_score + '%';
            
            // Update constraints and warnings
            const constraintsDiv = document.getElementById('constraintsWarnings');
            constraintsDiv.innerHTML = `
                <div class="small">
                    <div class="d-flex align-items-center mb-2">
                        <span class="benefit-indicator benefit-high"></span>
                        Good crop diversity for soil health
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="benefit-indicator benefit-medium"></span>
                        Consider nitrogen management between legumes and cereals
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="benefit-indicator benefit-high"></span>
                        Rotation supports pest management goals
                    </div>
                </div>
            `;
            
            // Update rotation impact visualizations if current plan exists
            if (currentRotationPlan) {
                updateRotationCharts(currentRotationPlan);
            }
        }
        
        // History Management System
        function saveToHistory(action) {
            if (!currentRotationPlan) return;
            
            // Remove any future history if we're not at the end
            if (historyIndex < rotationHistory.length - 1) {
                rotationHistory = rotationHistory.slice(0, historyIndex + 1);
            }
            
            // Add new state
            const state = {
                plan: JSON.parse(JSON.stringify(currentRotationPlan)),
                action: action,
                timestamp: new Date().toISOString()
            };
            
            rotationHistory.push(state);
            
            // Limit history size
            if (rotationHistory.length > maxHistorySize) {
                rotationHistory.shift();
            } else {
                historyIndex++;
            }
            
            updateHistoryButtons();
        }
        
        function undoAction() {
            if (historyIndex > 0) {
                historyIndex--;
                const state = rotationHistory[historyIndex];
                currentRotationPlan = JSON.parse(JSON.stringify(state.plan));
                displayRotationPlan(currentRotationPlan);
                updateHistoryButtons();
            }
        }
        
        function redoAction() {
            if (historyIndex < rotationHistory.length - 1) {
                historyIndex++;
                const state = rotationHistory[historyIndex];
                currentRotationPlan = JSON.parse(JSON.stringify(state.plan));
                displayRotationPlan(currentRotationPlan);
                updateHistoryButtons();
            }
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= rotationHistory.length - 1;
            
            // Update tooltips with action descriptions
            if (historyIndex > 0) {
                undoBtn.title = `Undo: ${rotationHistory[historyIndex].action}`;
            }
            if (historyIndex < rotationHistory.length - 1) {
                redoBtn.title = `Redo: ${rotationHistory[historyIndex + 1].action}`;
            }
        }
        
        // Advanced Year Management
        function updateCrop(yearIndex, newCrop) {
            if (currentRotationPlan && currentRotationPlan.rotation_sequence[yearIndex]) {
                const oldCrop = currentRotationPlan.rotation_sequence[yearIndex].crop;
                currentRotationPlan.rotation_sequence[yearIndex].crop = newCrop;
                currentRotationPlan.rotation_sequence[yearIndex].planting_date = getPlantingDate(newCrop);
                currentRotationPlan.rotation_sequence[yearIndex].harvest_date = getHarvestDate(newCrop);
                
                // Re-render the timeline
                displayRotationPlan(currentRotationPlan);
                
                saveToHistory(`Changed year ${yearIndex + 1} from ${oldCrop} to ${newCrop}`);
            }
        }
        
        function addYear() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            const lastYear = currentRotationPlan.rotation_sequence[currentRotationPlan.rotation_sequence.length - 1];
            const newYear = {
                year: lastYear.year + 1,
                crop: 'Corn',
                planting_date: getPlantingDate('Corn'),
                harvest_date: getHarvestDate('Corn')
            };
            
            currentRotationPlan.rotation_sequence.push(newYear);
            displayRotationPlan(currentRotationPlan);
            
            saveToHistory('Added new year to rotation');
        }
        
        function insertYear(index) {
            if (!currentRotationPlan) return;
            
            const targetYear = currentRotationPlan.rotation_sequence[index].year;
            const newYear = {
                year: targetYear,
                crop: 'Corn',
                planting_date: getPlantingDate('Corn'),
                harvest_date: getHarvestDate('Corn')
            };
            
            // Insert the new year
            currentRotationPlan.rotation_sequence.splice(index, 0, newYear);
            
            // Update subsequent years
            for (let i = index + 1; i < currentRotationPlan.rotation_sequence.length; i++) {
                currentRotationPlan.rotation_sequence[i].year++;
            }
            
            displayRotationPlan(currentRotationPlan);
            saveToHistory(`Inserted year before year ${index + 1}`);
        }
        
        function removeYear(index) {
            if (!currentRotationPlan || currentRotationPlan.rotation_sequence.length <= 2) {
                alert('Rotation must have at least 2 years');
                return;
            }
            
            const removedCrop = currentRotationPlan.rotation_sequence[index].crop;
            currentRotationPlan.rotation_sequence.splice(index, 1);
            
            // Update subsequent years
            const currentYear = new Date().getFullYear();
            currentRotationPlan.rotation_sequence.forEach((yearData, i) => {
                yearData.year = currentYear + i;
            });
            
            displayRotationPlan(currentRotationPlan);
            saveToHistory(`Removed year ${index + 1} (${removedCrop})`);
        }
        
        // Crop Substitution System
        function showCropSubstitutions(yearIndex, selectElement) {
            const currentCrop = selectElement.value;
            const substitutionPanel = document.getElementById(`substitution-${yearIndex}`);
            const substitutionCrops = document.getElementById(`substitution-crops-${yearIndex}`);
            
            // Get field context
            const context = {
                soil_type: selectedField?.soil_type || 'loam',
                drainage: selectedField?.drainage_class || 'well_drained',
                irrigation: selectedField?.irrigation_available || false
            };
            
            const substitutes = cropDatabase.getSubstitutions(currentCrop, context);
            
            if (substitutes.length === 0) {
                substitutionCrops.innerHTML = '<div class="small text-muted">No alternative crops available</div>';
            } else {
                substitutionCrops.innerHTML = substitutes.map(crop => {
                    const isRecommended = cropDatabase.getCropInfo(crop).good_predecessors.includes(
                        yearIndex > 0 ? currentRotationPlan.rotation_sequence[yearIndex - 1].crop : ''
                    );
                    
                    return `
                        <span class="substitution-crop ${isRecommended ? 'recommended' : ''}" 
                              onclick="substituteCrop(${yearIndex}, '${crop}')" 
                              title="${isRecommended ? 'Recommended based on previous crop' : 'Alternative option'}">
                            ${crop}
                        </span>
                    `;
                }).join('');
            }
            
            substitutionPanel.classList.add('show');
            
            // Hide panel when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function hidePanel(e) {
                    if (!substitutionPanel.contains(e.target) && e.target !== selectElement) {
                        substitutionPanel.classList.remove('show');
                        document.removeEventListener('click', hidePanel);
                    }
                });
            }, 100);
        }
        
        function substituteCrop(yearIndex, newCrop) {
            const selectElement = document.querySelector(`#rotationTimeline .rotation-year:nth-child(${yearIndex + 1}) select`);
            selectElement.value = newCrop;
            updateCrop(yearIndex, newCrop);
            
            // Hide substitution panel
            document.getElementById(`substitution-${yearIndex}`).classList.remove('show');
        }
        
        function showCropDetails(crop, yearIndex) {
            const cropInfo = cropDatabase.getCropInfo(crop);
            const modal = new bootstrap.Modal(document.getElementById('cropSubstitutionModal'));
            
            document.getElementById('substitutionDetails').innerHTML = `
                <h6>${crop} Details</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Nitrogen Requirements:</strong> ${cropInfo.nitrogen_needs || 'Medium'}<br>
                        <strong>Good Predecessors:</strong> ${cropInfo.good_predecessors.join(', ') || 'None specified'}<br>
                        <strong>Poor Predecessors:</strong> ${cropInfo.poor_predecessors.join(', ') || 'None specified'}
                    </div>
                    <div class="col-md-6">
                        <strong>Alternative Crops:</strong> ${cropInfo.substitutes.join(', ') || 'None specified'}<br>
                        <strong>Main Pest Concerns:</strong> ${cropInfo.pest_pressure.join(', ') || 'None specified'}<br>
                        ${cropInfo.nitrogen_fixation ? '<strong>Nitrogen Fixation:</strong> Yes' : ''}
                    </div>
                </div>
            `;
            
            modal.show();
        }
        
        // Template Management System
        function showTemplates() {
            const templateSelector = document.getElementById('templateSelector');
            const templateList = document.getElementById('templateList');
            
            templateList.innerHTML = '';
            
            Object.keys(rotationTemplates).forEach(templateId => {
                const template = rotationTemplates[templateId];
                const templateCard = document.createElement('div');
                templateCard.className = 'template-card';
                templateCard.onclick = () => selectTemplate(templateId);
                
                templateCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${template.name}</h6>
                            <div class="small text-muted mb-2">${template.description}</div>
                            <div class="small">
                                <strong>Sequence:</strong> ${template.sequence.join(' → ')}<br>
                                <strong>Benefits:</strong> ${template.benefits.join(', ')}
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-secondary">${template.sequence.length} years</span>
                        </div>
                    </div>
                `;
                
                templateList.appendChild(templateCard);
            });
            
            templateSelector.style.display = 'block';
        }
        
        function selectTemplate(templateId) {
            selectedTemplate = templateId;
            
            // Update UI to show selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('applyTemplateBtn').disabled = false;
        }
        
        function applyTemplate() {
            if (!selectedTemplate || !currentRotationPlan) return;
            
            const template = rotationTemplates[selectedTemplate];
            const currentYear = new Date().getFullYear();
            
            // Create new rotation sequence based on template
            const newSequence = template.sequence.map((crop, index) => ({
                year: currentYear + index,
                crop: crop,
                planting_date: getPlantingDate(crop),
                harvest_date: getHarvestDate(crop)
            }));
            
            currentRotationPlan.rotation_sequence = newSequence;
            displayRotationPlan(currentRotationPlan);
            
            hideTemplates();
            saveToHistory(`Applied ${template.name} template`);
        }
        
        function hideTemplates() {
            document.getElementById('templateSelector').style.display = 'none';
            selectedTemplate = null;
            document.getElementById('applyTemplateBtn').disabled = true;
        }
        
        async function optimizeRotation() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            try {
                showLoading(true);
                
                // Simulate optimization
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Intelligent optimization based on crop compatibility
                const optimizedSequence = [...currentRotationPlan.rotation_sequence];
                const crops = availableCrops.filter(crop => crop !== 'Cover Crops');
                
                // Try to create a better sequence
                for (let i = 0; i < optimizedSequence.length; i++) {
                    const currentCrop = optimizedSequence[i].crop;
                    const previousCrop = i > 0 ? optimizedSequence[i - 1].crop : null;
                    
                    // Find better alternatives
                    const alternatives = crops.filter(crop => {
                        if (crop === currentCrop) return false;
                        const cropInfo = cropDatabase.getCropInfo(crop);
                        return !previousCrop || !cropInfo.poor_predecessors.includes(previousCrop);
                    });
                    
                    if (alternatives.length > 0 && Math.random() > 0.7) {
                        const newCrop = alternatives[Math.floor(Math.random() * alternatives.length)];
                        optimizedSequence[i].crop = newCrop;
                        optimizedSequence[i].planting_date = getPlantingDate(newCrop);
                        optimizedSequence[i].harvest_date = getHarvestDate(newCrop);
                    }
                }
                
                currentRotationPlan.rotation_sequence = optimizedSequence;
                
                // Update metrics with improved values
                currentRotationPlan.metrics.soil_health_score = (parseFloat(currentRotationPlan.metrics.soil_health_score) + 5).toFixed(1);
                currentRotationPlan.metrics.sustainability_score = (parseFloat(currentRotationPlan.metrics.sustainability_score) + 3).toFixed(1);
                
                displayRotationPlan(currentRotationPlan);
                saveToHistory('Optimized rotation sequence');
                
                alert('Rotation plan optimized successfully!');
                
            } catch (error) {
                console.error('Error optimizing rotation:', error);
                alert('Error optimizing rotation. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        async function compareScenarios() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            try {
                showLoading(true);
                
                // Generate comparison scenarios
                const scenarios = generateComparisonScenarios();
                displayScenarioComparison(scenarios);
                
                document.getElementById('comparisonSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error comparing scenarios:', error);
                alert('Error comparing scenarios. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        function generateComparisonScenarios() {
            const baseScenario = currentRotationPlan.rotation_sequence.map(item => item.crop);
            
            return [
                {
                    name: 'Current Plan',
                    crops: baseScenario,
                    soil_health: parseFloat(currentRotationPlan.metrics.soil_health_score),
                    profit: parseFloat(currentRotationPlan.metrics.profit_potential.replace(/[$\/acre]/g, '')),
                    risk: currentRotationPlan.metrics.risk_level,
                    sustainability: parseFloat(currentRotationPlan.metrics.sustainability_score)
                },
                {
                    name: 'High Profit Focus',
                    crops: ['Corn', 'Corn', 'Soybeans', 'Wheat'],
                    soil_health: 65.0,
                    profit: 520,
                    risk: 'High',
                    sustainability: 60.0
                },
                {
                    name: 'Soil Health Focus',
                    crops: ['Cover Crops', 'Alfalfa', 'Corn', 'Soybeans'],
                    soil_health: 85.0,
                    profit: 380,
                    risk: 'Low',
                    sustainability: 90.0
                },
                {
                    name: 'Balanced Approach',
                    crops: ['Soybeans', 'Corn', 'Wheat', 'Cover Crops'],
                    soil_health: 75.0,
                    profit: 450,
                    risk: 'Medium',
                    sustainability: 78.0
                }
            ];
        }
        
        function displayScenarioComparison(scenarios) {
            const comparisonTable = document.getElementById('comparisonTable');
            
            let tableHTML = `
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Scenario</th>
                            <th>Rotation Sequence</th>
                            <th>Soil Health</th>
                            <th>Profit Potential</th>
                            <th>Risk Level</th>
                            <th>Sustainability</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            scenarios.forEach((scenario, index) => {
                const isCurrentPlan = index === 0;
                const rowClass = isCurrentPlan ? 'table-primary' : '';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>
                            <strong>${scenario.name}</strong>
                            ${isCurrentPlan ? '<span class="badge bg-primary ms-2">Current</span>' : ''}
                        </td>
                        <td class="small">${scenario.crops.join(' → ')}</td>
                        <td>
                            <span class="metric-value">${scenario.soil_health}%</span>
                        </td>
                        <td>
                            <span class="metric-value">$${scenario.profit}/acre</span>
                        </td>
                        <td>
                            <span class="badge ${getRiskBadgeClass(scenario.risk)}">${scenario.risk}</span>
                        </td>
                        <td>
                            <span class="metric-value">${scenario.sustainability}%</span>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            comparisonTable.innerHTML = tableHTML;
        }
        
        function getRiskBadgeClass(risk) {
            switch(risk.toLowerCase()) {
                case 'low': return 'bg-success';
                case 'medium': return 'bg-warning';
                case 'high': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        async function analyzeBenefits() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            alert('Benefits analysis would show detailed breakdown of environmental, economic, and soil health benefits of your rotation plan.');
        }
        
        async function economicAnalysis() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            alert('Economic analysis would show detailed cost-benefit analysis, cash flow projections, and ROI calculations for your rotation plan.');
        }
        
        // Conflict Resolution System
        function showConflictResolution() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('conflictResolutionModal'));
            const conflictsList = document.getElementById('conflictsList');
            
            if (currentConflicts.length === 0) {
                conflictsList.innerHTML = `
                    <div class="text-center text-success">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <h5>No conflicts detected!</h5>
                        <p>Your rotation plan looks good with no major issues identified.</p>
                    </div>
                `;
            } else {
                let conflictsHtml = '<div class="mb-3"><h6>Detected Issues and Suggestions:</h6></div>';
                
                currentConflicts.forEach((conflict, index) => {
                    const resolutions = generateConflictResolutions(conflict);
                    
                    conflictsHtml += `
                        <div class="conflict-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong>${conflict.type.replace('_', ' ').toUpperCase()}</strong>
                                    ${conflict.year ? `(Year ${conflict.year})` : ''}
                                    <p class="mb-2">${conflict.message}</p>
                                </div>
                                <span class="badge bg-${conflict.severity === 'error' ? 'danger' : 'warning'}">
                                    ${conflict.severity}
                                </span>
                            </div>
                            
                            ${resolutions.map(resolution => `
                                <div class="conflict-resolution">
                                    <strong>Suggestion:</strong> ${resolution.description}
                                    <button class="btn btn-sm btn-outline-primary ms-2" 
                                            onclick="applyResolution(${index}, '${resolution.action}', '${resolution.value || ''}')">
                                        Apply
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
                
                conflictsList.innerHTML = conflictsHtml;
            }
            
            modal.show();
        }
        
        function generateConflictResolutions(conflict) {
            const resolutions = [];
            
            switch (conflict.type) {
                case 'monoculture':
                    const alternatives = availableCrops.filter(crop => crop !== conflict.crop);
                    resolutions.push({
                        description: `Replace one ${conflict.crop} with ${alternatives[0]}`,
                        action: 'substitute_crop',
                        value: alternatives[0]
                    });
                    break;
                    
                case 'poor_sequence':
                    const cropInfo = cropDatabase.getCropInfo(conflict.crop);
                    const goodAlternatives = availableCrops.filter(crop => 
                        !cropInfo.poor_predecessors.includes(conflict.previous)
                    );
                    
                    if (goodAlternatives.length > 0) {
                        resolutions.push({
                            description: `Replace ${conflict.crop} with ${goodAlternatives[0]}`,
                            action: 'substitute_crop',
                            value: goodAlternatives[0]
                        });
                    }
                    break;
                    
                case 'low_diversity':
                    resolutions.push({
                        description: 'Add more diverse crops to the rotation',
                        action: 'increase_diversity',
                        value: ''
                    });
                    break;
            }
            
            return resolutions;
        }
        
        function applyResolution(conflictIndex, action, value) {
            const conflict = currentConflicts[conflictIndex];
            
            switch (action) {
                case 'substitute_crop':
                    if (conflict.year) {
                        const yearIndex = conflict.year - 1;
                        currentRotationPlan.rotation_sequence[yearIndex].crop = value;
                        currentRotationPlan.rotation_sequence[yearIndex].planting_date = getPlantingDate(value);
                        currentRotationPlan.rotation_sequence[yearIndex].harvest_date = getHarvestDate(value);
                    }
                    break;
                    
                case 'increase_diversity':
                    // Add a diverse crop to the rotation
                    addYear();
                    const lastIndex = currentRotationPlan.rotation_sequence.length - 1;
                    const diverseCrops = ['Alfalfa', 'Clover', 'Sunflower', 'Canola'];
                    const diverseCrop = diverseCrops[Math.floor(Math.random() * diverseCrops.length)];
                    
                    currentRotationPlan.rotation_sequence[lastIndex].crop = diverseCrop;
                    currentRotationPlan.rotation_sequence[lastIndex].planting_date = getPlantingDate(diverseCrop);
                    currentRotationPlan.rotation_sequence[lastIndex].harvest_date = getHarvestDate(diverseCrop);
                    break;
            }
            
            displayRotationPlan(currentRotationPlan);
            saveToHistory(`Applied resolution: ${action}`);
            
            // Close modal and show success message
            const modal = bootstrap.Modal.getInstance(document.getElementById('conflictResolutionModal'));
            modal.hide();
            
            alert('Resolution applied successfully!');
        }
        
        function applyConflictResolutions() {
            if (currentConflicts.length === 0) return;
            
            currentConflicts.forEach((conflict, index) => {
                const resolutions = generateConflictResolutions(conflict);
                if (resolutions.length > 0) {
                    applyResolution(index, resolutions[0].action, resolutions[0].value);
                }
            });
        }
        
        // Enhanced crop substitution modal handlers
        function applySubstitution() {
            // This function would be called from the substitution modal
            // Implementation depends on the specific substitution context
            console.log('Apply substitution called');
        }
        
        // Additional utility functions
        function exportRotationPlan() {
            if (!currentRotationPlan) {
                alert('No rotation plan to export');
                return;
            }
            
            const exportData = {
                plan: currentRotationPlan,
                field: selectedField,
                export_date: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                type: 'application/json' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rotation_plan_${selectedField?.field_name || 'export'}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function shareRotationPlan() {
            if (!currentRotationPlan) {
                alert('No rotation plan to share');
                return;
            }
            
            const shareData = {
                title: `Crop Rotation Plan - ${selectedField?.field_name || 'Field'}`,
                text: `${currentRotationPlan.rotation_sequence.length}-year rotation: ${currentRotationPlan.rotation_sequence.map(y => y.crop).join(' → ')}`,
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(`${shareData.title}\n${shareData.text}\n${shareData.url}`)
                    .then(() => alert('Rotation plan details copied to clipboard!'));
            }
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }
        
        // Rotation Impact Visualization Functions
        let rotationCharts = {};
        
        function initializeRotationCharts() {
            // Initialize all rotation impact charts
            initializeSoilHealthChart();
            initializeEconomicChart();
            initializeDiversityChart();
            initializeSustainabilityChart();
        }
        
        function initializeSoilHealthChart() {
            const ctx = document.getElementById('soilHealthChart').getContext('2d');
            rotationCharts.soilHealth = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Soil Health Score',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Organic Matter %',
                        data: [],
                        borderColor: '#8B4513',
                        backgroundColor: 'rgba(139, 69, 19, 0.1)',
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function initializeEconomicChart() {
            const ctx = document.getElementById('economicChart').getContext('2d');
            rotationCharts.economic = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue ($)',
                        data: [],
                        backgroundColor: '#007bff',
                        borderColor: '#0056b3',
                        borderWidth: 1
                    }, {
                        label: 'Costs ($)',
                        data: [],
                        backgroundColor: '#dc3545',
                        borderColor: '#c82333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function initializeDiversityChart() {
            const ctx = document.getElementById('diversityChart').getContext('2d');
            rotationCharts.diversity = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#ff6384',
                            '#36a2eb',
                            '#cc65fe',
                            '#ffce56',
                            '#ff9f40',
                            '#4bc0c0',
                            '#9966ff',
                            '#ff6384'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        function initializeSustainabilityChart() {
            const ctx = document.getElementById('sustainabilityChart').getContext('2d');
            rotationCharts.sustainability = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Soil Health', 'Water Efficiency', 'Biodiversity', 'Carbon Sequestration', 'Pest Resistance', 'Nutrient Cycling'],
                    datasets: [{
                        label: 'Current Plan',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#28a745'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function updateRotationCharts(rotationPlan) {
            if (!rotationPlan || !rotationPlan.rotation_sequence) return;
            
            // Show visualization section
            document.getElementById('visualizationSection').style.display = 'block';
            
            // Update each chart with rotation data
            updateSoilHealthChart(rotationPlan);
            updateEconomicChart(rotationPlan);
            updateDiversityChart(rotationPlan);
            updateSustainabilityChart(rotationPlan);
        }
        
        function updateSoilHealthChart(rotationPlan) {
            if (!rotationCharts.soilHealth) return;
            
            const years = rotationPlan.rotation_sequence.map((_, index) => `Year ${index + 1}`);
            const soilHealthScores = rotationPlan.rotation_sequence.map((year, index) => {
                // Calculate progressive soil health improvement
                const baseScore = 60;
                const improvement = index * 5; // 5 points per year
                const cropBonus = getCropSoilHealthBonus(year.crop);
                return Math.min(100, baseScore + improvement + cropBonus);
            });
            
            const organicMatter = rotationPlan.rotation_sequence.map((year, index) => {
                const baseOM = 2.5;
                const improvement = index * 0.3;
                const cropBonus = getCropOrganicMatterBonus(year.crop);
                return Math.min(6.0, baseOM + improvement + cropBonus);
            });
            
            rotationCharts.soilHealth.data.labels = years;
            rotationCharts.soilHealth.data.datasets[0].data = soilHealthScores;
            rotationCharts.soilHealth.data.datasets[1].data = organicMatter;
            rotationCharts.soilHealth.update();
        }
        
        function updateEconomicChart(rotationPlan) {
            if (!rotationCharts.economic) return;
            
            const years = rotationPlan.rotation_sequence.map((_, index) => `Year ${index + 1}`);
            const revenues = rotationPlan.rotation_sequence.map(year => getCropRevenue(year.crop));
            const costs = rotationPlan.rotation_sequence.map(year => getCropCosts(year.crop));
            
            rotationCharts.economic.data.labels = years;
            rotationCharts.economic.data.datasets[0].data = revenues;
            rotationCharts.economic.data.datasets[1].data = costs;
            rotationCharts.economic.update();
        }
        
        function updateDiversityChart(rotationPlan) {
            if (!rotationCharts.diversity) return;
            
            // Count crop occurrences in rotation
            const cropCounts = {};
            rotationPlan.rotation_sequence.forEach(year => {
                cropCounts[year.crop] = (cropCounts[year.crop] || 0) + 1;
            });
            
            const crops = Object.keys(cropCounts);
            const counts = Object.values(cropCounts);
            
            rotationCharts.diversity.data.labels = crops;
            rotationCharts.diversity.data.datasets[0].data = counts;
            rotationCharts.diversity.update();
        }
        
        function updateSustainabilityChart(rotationPlan) {
            if (!rotationCharts.sustainability) return;
            
            // Calculate sustainability metrics
            const metrics = calculateSustainabilityMetrics(rotationPlan);
            
            rotationCharts.sustainability.data.datasets[0].data = [
                metrics.soilHealth,
                metrics.waterEfficiency,
                metrics.biodiversity,
                metrics.carbonSequestration,
                metrics.pestResistance,
                metrics.nutrientCycling
            ];
            rotationCharts.sustainability.update();
        }
        
        // Helper functions for chart data calculation
        function getCropSoilHealthBonus(crop) {
            const bonuses = {
                'Cover Crops': 15,
                'Legumes': 10,
                'Clover': 10,
                'Alfalfa': 8,
                'Soybeans': 8,
                'Corn': -2,
                'Wheat': 2,
                'Canola': 5
            };
            return bonuses[crop] || 0;
        }
        
        function getCropOrganicMatterBonus(crop) {
            const bonuses = {
                'Cover Crops': 0.8,
                'Legumes': 0.5,
                'Clover': 0.5,
                'Alfalfa': 0.4,
                'Soybeans': 0.3,
                'Corn': -0.1,
                'Wheat': 0.1,
                'Canola': 0.2
            };
            return bonuses[crop] || 0;
        }
        
        function getCropRevenue(crop) {
            const revenues = {
                'Corn': 1200,
                'Soybeans': 900,
                'Wheat': 700,
                'Canola': 800,
                'Barley': 600,
                'Oats': 500,
                'Legumes': 400,
                'Cover Crops': 0,
                'Clover': 300,
                'Alfalfa': 600
            };
            return revenues[crop] || 500;
        }
        
        function getCropCosts(crop) {
            const costs = {
                'Corn': 800,
                'Soybeans': 600,
                'Wheat': 450,
                'Canola': 500,
                'Barley': 400,
                'Oats': 350,
                'Legumes': 300,
                'Cover Crops': 150,
                'Clover': 200,
                'Alfalfa': 400
            };
            return costs[crop] || 350;
        }
        
        function calculateSustainabilityMetrics(rotationPlan) {
            // Calculate various sustainability metrics based on crop rotation
            const crops = rotationPlan.rotation_sequence.map(year => year.crop);
            
            // Soil Health: based on crop diversity and soil-improving crops
            const soilImprovers = ['Cover Crops', 'Legumes', 'Clover', 'Alfalfa', 'Soybeans'];
            const soilHealth = Math.min(100, 50 + (crops.filter(crop => soilImprovers.includes(crop)).length * 15));
            
            // Water Efficiency: based on drought-tolerant crops
            const waterEfficient = ['Canola', 'Barley', 'Cover Crops'];
            const waterEfficiency = Math.min(100, 40 + (crops.filter(crop => waterEfficient.includes(crop)).length * 20));
            
            // Biodiversity: based on crop diversity
            const uniqueCrops = new Set(crops).size;
            const biodiversity = Math.min(100, uniqueCrops * 20);
            
            // Carbon Sequestration: based on carbon-sequestering crops
            const carbonCrops = ['Cover Crops', 'Alfalfa', 'Clover', 'Legumes'];
            const carbonSequestration = Math.min(100, 30 + (crops.filter(crop => carbonCrops.includes(crop)).length * 25));
            
            // Pest Resistance: based on rotation diversity
            const pestResistance = Math.min(100, 40 + (uniqueCrops * 15));
            
            // Nutrient Cycling: based on nitrogen-fixing crops
            const nitrogenFixers = ['Legumes', 'Soybeans', 'Clover', 'Alfalfa'];
            const nutrientCycling = Math.min(100, 35 + (crops.filter(crop => nitrogenFixers.includes(crop)).length * 20));
            
            return {
                soilHealth,
                waterEfficiency,
                biodiversity,
                carbonSequestration,
                pestResistance,
                nutrientCycling
            };
        }
    </script>
</body>
</html>