<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Rotation Planning - AFAS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .agricultural-card {
            border-left: 4px solid #28a745;
            transition: transform 0.2s;
        }
        .agricultural-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .field-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .field-card.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8, #f8fff8);
        }
        .field-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .rotation-timeline {
            display: flex;
            overflow-x: auto;
            padding: 20px 0;
            margin: 20px 0;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .rotation-year {
            min-width: 200px;
            margin: 0 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .rotation-year.current {
            border-color: #28a745;
            background: #e8f5e8;
        }
        .crop-selection {
            margin-top: 10px;
        }
        .crop-option {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .crop-option.selected {
            background: #28a745;
            color: white;
        }
        .crop-option:hover {
            background: #6c757d;
            color: white;
        }
        .plan-metrics {
            background: linear-gradient(135deg, #e3f2fd, #ffffff);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .metric-item:last-child {
            border-bottom: none;
        }
        .metric-value {
            font-weight: bold;
            color: #28a745;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .comparison-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .scenario-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .benefit-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .benefit-high { background-color: #28a745; }
        .benefit-medium { background-color: #ffc107; }
        .benefit-low { background-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-seedling"></i> AFAS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/crop-selection">Crop Selection</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/rotation-planning">Rotation Planning</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/goal-prioritization">Goal Prioritization</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status"></div>
            <p>Processing rotation plan...</p>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1><i class="fas fa-sync-alt"></i> Crop Rotation Planning</h1>
                <p class="lead">Design and optimize multi-year crop rotation plans for your fields</p>
            </div>
        </div>
        
        <!-- Field Management Section -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card agricultural-card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-map-marked-alt"></i> Field Management</h5>
                        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#newFieldModal">
                            <i class="fas fa-plus"></i> Add Field
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="fieldsList">
                            <!-- Fields will be dynamically loaded -->
                        </div>
                        
                        <!-- Field Details Form -->
                        <div id="fieldDetailsForm" style="display: none;">
                            <h6>Field Details</h6>
                            <form id="fieldForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Field Name</label>
                                        <input type="text" class="form-control" id="fieldName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Size (acres)</label>
                                        <input type="number" class="form-control" id="fieldSize" step="0.1" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Soil Type</label>
                                        <select class="form-control" id="soilType">
                                            <option value="">Select soil type</option>
                                            <option value="clay">Clay</option>
                                            <option value="loam">Loam</option>
                                            <option value="sandy">Sandy</option>
                                            <option value="silty">Silty</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Drainage Class</label>
                                        <select class="form-control" id="drainageClass">
                                            <option value="">Select drainage class</option>
                                            <option value="well_drained">Well Drained</option>
                                            <option value="moderately_drained">Moderately Drained</option>
                                            <option value="poorly_drained">Poorly Drained</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="irrigationAvailable">
                                            <label class="form-check-label" for="irrigationAvailable">
                                                Irrigation Available
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="col-lg-4">
                <div class="card agricultural-card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-tools"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="generateRotationPlan()">
                            <i class="fas fa-magic"></i> Generate Rotation Plan
                        </button>
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="compareScenarios()">
                            <i class="fas fa-balance-scale"></i> Compare Scenarios
                        </button>
                        <button class="btn btn-outline-warning w-100 mb-2" onclick="analyzeBenefits()">
                            <i class="fas fa-chart-line"></i> Analyze Benefits
                        </button>
                        <button class="btn btn-outline-info w-100" onclick="economicAnalysis()">
                            <i class="fas fa-calculator"></i> Economic Analysis
                        </button>
                    </div>
                </div>
                
                <!-- Selected Field Info -->
                <div class="card agricultural-card" id="selectedFieldInfo" style="display: none;">
                    <div class="card-header bg-secondary text-white">
                        <h5><i class="fas fa-info-circle"></i> Selected Field</h5>
                    </div>
                    <div class="card-body" id="fieldInfoContent">
                        <!-- Field information will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rotation Timeline Section -->
        <div class="row" id="rotationSection" style="display: none;">
            <div class="col-12">
                <div class="card agricultural-card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-calendar-alt"></i> Rotation Timeline</h5>
                        <div>
                            <button class="btn btn-light btn-sm" onclick="addYear()">
                                <i class="fas fa-plus"></i> Add Year
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="optimizeRotation()">
                                <i class="fas fa-cogs"></i> Optimize
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="rotation-timeline" id="rotationTimeline">
                            <!-- Timeline will be dynamically populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Plan Metrics Section -->
        <div class="row" id="metricsSection" style="display: none;">
            <div class="col-md-6">
                <div class="plan-metrics">
                    <h5><i class="fas fa-chart-bar"></i> Plan Performance</h5>
                    <div class="metric-item">
                        <span>Soil Health Score</span>
                        <span class="metric-value" id="soilHealthScore">-</span>
                    </div>
                    <div class="metric-item">
                        <span>Profit Potential</span>
                        <span class="metric-value" id="profitPotential">-</span>
                    </div>
                    <div class="metric-item">
                        <span>Risk Level</span>
                        <span class="metric-value" id="riskLevel">-</span>
                    </div>
                    <div class="metric-item">
                        <span>Sustainability Score</span>
                        <span class="metric-value" id="sustainabilityScore">-</span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="plan-metrics">
                    <h5><i class="fas fa-exclamation-triangle"></i> Constraints & Warnings</h5>
                    <div id="constraintsWarnings">
                        <!-- Warnings will be dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scenario Comparison Section -->
        <div class="row" id="comparisonSection" style="display: none;">
            <div class="col-12">
                <div class="card agricultural-card">
                    <div class="card-header bg-warning text-white">
                        <h5><i class="fas fa-balance-scale"></i> Scenario Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="comparison-table" id="comparisonTable">
                            <!-- Comparison results will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Field Modal -->
    <div class="modal fade" id="newFieldModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Field</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="newFieldForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Field Name *</label>
                                <input type="text" class="form-control" name="field_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Farm ID *</label>
                                <input type="text" class="form-control" name="farm_id" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Size (acres) *</label>
                                <input type="number" class="form-control" name="size_acres" step="0.1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Soil Type</label>
                                <select class="form-control" name="soil_type">
                                    <option value="">Select soil type</option>
                                    <option value="clay">Clay</option>
                                    <option value="loam">Loam</option>
                                    <option value="sandy">Sandy</option>
                                    <option value="silty">Silty</option>
                                    <option value="clayey_loam">Clayey Loam</option>
                                    <option value="sandy_loam">Sandy Loam</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Drainage Class</label>
                                <select class="form-control" name="drainage_class">
                                    <option value="">Select drainage class</option>
                                    <option value="well_drained">Well Drained</option>
                                    <option value="moderately_drained">Moderately Drained</option>
                                    <option value="poorly_drained">Poorly Drained</option>
                                    <option value="somewhat_poorly_drained">Somewhat Poorly Drained</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Slope (%)</label>
                                <input type="number" class="form-control" name="slope_percent" step="0.1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Climate Zone</label>
                                <input type="text" class="form-control" name="climate_zone" placeholder="e.g., 5a, 6b">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Elevation (ft)</label>
                                <input type="number" class="form-control" name="elevation_ft">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="irrigation_available" id="modalIrrigation">
                                    <label class="form-check-label" for="modalIrrigation">
                                        Irrigation Available
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Create Field</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentFields = [];
        let selectedField = null;
        let currentRotationPlan = null;
        let availableCrops = [
            'Corn', 'Soybeans', 'Wheat', 'Oats', 'Barley', 'Rye',
            'Alfalfa', 'Clover', 'Cotton', 'Rice', 'Potatoes', 'Tomatoes',
            'Sunflower', 'Canola', 'Peas', 'Beans', 'Cover Crops'
        ];
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadFields();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // New field form submission
            document.getElementById('newFieldForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createNewField(this);
            });
        }
        
        async function loadFields() {
            try {
                // For demo purposes, create some sample fields
                // In production, this would fetch from the API
                currentFields = [
                    {
                        field_id: 'field_demo_001',
                        field_name: 'North Field',
                        farm_id: 'demo_farm',
                        size_acres: 40.0,
                        soil_type: 'loam',
                        drainage_class: 'well_drained',
                        irrigation_available: true
                    },
                    {
                        field_id: 'field_demo_002', 
                        field_name: 'South Field',
                        farm_id: 'demo_farm',
                        size_acres: 25.5,
                        soil_type: 'clay',
                        drainage_class: 'moderately_drained',
                        irrigation_available: false
                    }
                ];
                
                displayFields();
            } catch (error) {
                console.error('Error loading fields:', error);
            }
        }
        
        function displayFields() {
            const fieldsContainer = document.getElementById('fieldsList');
            fieldsContainer.innerHTML = '';
            
            if (currentFields.length === 0) {
                fieldsContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                        <p>No fields added yet. Click "Add Field" to get started.</p>
                    </div>
                `;
                return;
            }
            
            currentFields.forEach(field => {
                const fieldCard = document.createElement('div');
                fieldCard.className = 'field-card';
                fieldCard.onclick = () => selectField(field);
                
                fieldCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${field.field_name}</h6>
                            <p class="text-muted small mb-1">
                                ${field.size_acres} acres • ${field.soil_type || 'Unknown soil'} • 
                                ${field.drainage_class || 'Unknown drainage'}
                            </p>
                            <div class="small">
                                ${field.irrigation_available ? '<span class="badge bg-primary"><i class="fas fa-tint"></i> Irrigated</span>' : ''}
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${field.field_id}</small>
                        </div>
                    </div>
                `;
                
                fieldsContainer.appendChild(fieldCard);
            });
        }
        
        function selectField(field) {
            // Update UI to show selected field
            document.querySelectorAll('.field-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            selectedField = field;
            
            // Show field info panel
            const infoPanel = document.getElementById('selectedFieldInfo');
            const infoContent = document.getElementById('fieldInfoContent');
            
            infoContent.innerHTML = `
                <h6>${field.field_name}</h6>
                <div class="row small">
                    <div class="col-6">
                        <strong>Size:</strong> ${field.size_acres} acres
                    </div>
                    <div class="col-6">
                        <strong>Farm:</strong> ${field.farm_id}
                    </div>
                    <div class="col-6">
                        <strong>Soil:</strong> ${field.soil_type || 'Unknown'}
                    </div>
                    <div class="col-6">
                        <strong>Drainage:</strong> ${field.drainage_class || 'Unknown'}
                    </div>
                    <div class="col-12 mt-2">
                        <strong>Irrigation:</strong> ${field.irrigation_available ? 'Available' : 'Not available'}
                    </div>
                </div>
            `;
            
            infoPanel.style.display = 'block';
        }
        
        async function createNewField(form) {
            const formData = new FormData(form);
            const fieldData = {
                field_name: formData.get('field_name'),
                farm_id: formData.get('farm_id'),
                size_acres: parseFloat(formData.get('size_acres')),
                soil_type: formData.get('soil_type'),
                drainage_class: formData.get('drainage_class'),
                slope_percent: formData.get('slope_percent') ? parseFloat(formData.get('slope_percent')) : null,
                irrigation_available: formData.has('irrigation_available'),
                climate_zone: formData.get('climate_zone'),
                elevation_ft: formData.get('elevation_ft') ? parseFloat(formData.get('elevation_ft')) : null
            };
            
            try {
                showLoading(true);
                
                const response = await fetch('/api/v1/rotations/fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(fieldData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Add the new field to current fields
                currentFields.push({
                    field_id: result.field_id,
                    field_name: fieldData.field_name,
                    farm_id: fieldData.farm_id,
                    size_acres: fieldData.size_acres,
                    soil_type: fieldData.soil_type,
                    drainage_class: fieldData.drainage_class,
                    irrigation_available: fieldData.irrigation_available
                });
                
                displayFields();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('newFieldModal'));
                modal.hide();
                form.reset();
                
                alert('Field created successfully!');
                
            } catch (error) {
                console.error('Error creating field:', error);
                alert('Error creating field. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        async function generateRotationPlan() {
            if (!selectedField) {
                alert('Please select a field first');
                return;
            }
            
            try {
                showLoading(true);
                
                // Demo rotation plan generation
                const demoRotation = generateDemoRotation(selectedField);
                displayRotationPlan(demoRotation);
                
                document.getElementById('rotationSection').style.display = 'block';
                document.getElementById('metricsSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error generating rotation plan:', error);
                alert('Error generating rotation plan. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        function generateDemoRotation(field) {
            // Generate a demo 4-year rotation plan
            const rotationOptions = [
                ['Corn', 'Soybeans', 'Wheat', 'Cover Crops'],
                ['Soybeans', 'Corn', 'Oats', 'Alfalfa'],
                ['Cotton', 'Wheat', 'Soybeans', 'Cover Crops'],
                ['Potatoes', 'Wheat', 'Clover', 'Corn']
            ];
            
            const selectedRotation = rotationOptions[Math.floor(Math.random() * rotationOptions.length)];
            const currentYear = new Date().getFullYear();
            
            return {
                plan_id: `plan_${field.field_id}_${Date.now()}`,
                field_id: field.field_id,
                rotation_sequence: selectedRotation.map((crop, index) => ({
                    year: currentYear + index,
                    crop: crop,
                    planting_date: getPlantingDate(crop),
                    harvest_date: getHarvestDate(crop)
                })),
                metrics: {
                    soil_health_score: (Math.random() * 40 + 60).toFixed(1),
                    profit_potential: '$' + (Math.random() * 300 + 400).toFixed(0) + '/acre',
                    risk_level: ['Low', 'Medium', 'High'][Math.floor(Math.random() * 3)],
                    sustainability_score: (Math.random() * 30 + 70).toFixed(1)
                }
            };
        }
        
        function getPlantingDate(crop) {
            const plantingDates = {
                'Corn': 'April 15',
                'Soybeans': 'May 1',
                'Wheat': 'October 15',
                'Cotton': 'April 20',
                'Oats': 'March 15',
                'Cover Crops': 'September 1',
                'Alfalfa': 'April 1',
                'Clover': 'April 10',
                'Potatoes': 'April 5'
            };
            return plantingDates[crop] || 'April 15';
        }
        
        function getHarvestDate(crop) {
            const harvestDates = {
                'Corn': 'October 15',
                'Soybeans': 'September 30',
                'Wheat': 'July 15',
                'Cotton': 'October 1',
                'Oats': 'July 20',
                'Cover Crops': 'May 15',
                'Alfalfa': 'Multiple cuts',
                'Clover': 'August 15',
                'Potatoes': 'September 1'
            };
            return harvestDates[crop] || 'September 15';
        }
        
        function displayRotationPlan(plan) {
            currentRotationPlan = plan;
            const timeline = document.getElementById('rotationTimeline');
            timeline.innerHTML = '';
            
            plan.rotation_sequence.forEach((yearData, index) => {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'rotation-year';
                if (index === 0) yearDiv.classList.add('current');
                
                yearDiv.innerHTML = `
                    <h6>Year ${index + 1}</h6>
                    <div class="fw-bold">${yearData.year}</div>
                    <div class="crop-selection mt-2">
                        <select class="form-control form-control-sm" onchange="updateCrop(${index}, this.value)">
                            ${availableCrops.map(crop => 
                                `<option value="${crop}" ${crop === yearData.crop ? 'selected' : ''}>${crop}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="small mt-2 text-muted">
                        <div>Plant: ${yearData.planting_date}</div>
                        <div>Harvest: ${yearData.harvest_date}</div>
                    </div>
                `;
                
                timeline.appendChild(yearDiv);
            });
            
            // Update metrics
            updateMetrics(plan.metrics);
        }
        
        function updateMetrics(metrics) {
            document.getElementById('soilHealthScore').textContent = metrics.soil_health_score + '%';
            document.getElementById('profitPotential').textContent = metrics.profit_potential;
            document.getElementById('riskLevel').textContent = metrics.risk_level;
            document.getElementById('sustainabilityScore').textContent = metrics.sustainability_score + '%';
            
            // Update constraints and warnings
            const constraintsDiv = document.getElementById('constraintsWarnings');
            constraintsDiv.innerHTML = `
                <div class="small">
                    <div class="d-flex align-items-center mb-2">
                        <span class="benefit-indicator benefit-high"></span>
                        Good crop diversity for soil health
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="benefit-indicator benefit-medium"></span>
                        Consider nitrogen management between legumes and cereals
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="benefit-indicator benefit-high"></span>
                        Rotation supports pest management goals
                    </div>
                </div>
            `;
        }
        
        function updateCrop(yearIndex, newCrop) {
            if (currentRotationPlan && currentRotationPlan.rotation_sequence[yearIndex]) {
                currentRotationPlan.rotation_sequence[yearIndex].crop = newCrop;
                currentRotationPlan.rotation_sequence[yearIndex].planting_date = getPlantingDate(newCrop);
                currentRotationPlan.rotation_sequence[yearIndex].harvest_date = getHarvestDate(newCrop);
                
                // Re-render the timeline
                displayRotationPlan(currentRotationPlan);
            }
        }
        
        function addYear() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            const lastYear = currentRotationPlan.rotation_sequence[currentRotationPlan.rotation_sequence.length - 1];
            const newYear = {
                year: lastYear.year + 1,
                crop: 'Corn',
                planting_date: getPlantingDate('Corn'),
                harvest_date: getHarvestDate('Corn')
            };
            
            currentRotationPlan.rotation_sequence.push(newYear);
            displayRotationPlan(currentRotationPlan);
        }
        
        async function optimizeRotation() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            try {
                showLoading(true);
                
                // Simulate optimization
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Demo optimization: shuffle the crops
                const optimizedSequence = [...currentRotationPlan.rotation_sequence];
                const crops = optimizedSequence.map(item => item.crop);
                const shuffledCrops = crops.sort(() => Math.random() - 0.5);
                
                optimizedSequence.forEach((item, index) => {
                    item.crop = shuffledCrops[index];
                    item.planting_date = getPlantingDate(item.crop);
                    item.harvest_date = getHarvestDate(item.crop);
                });
                
                currentRotationPlan.rotation_sequence = optimizedSequence;
                
                // Update metrics with improved values
                currentRotationPlan.metrics.soil_health_score = (parseFloat(currentRotationPlan.metrics.soil_health_score) + 5).toFixed(1);
                currentRotationPlan.metrics.sustainability_score = (parseFloat(currentRotationPlan.metrics.sustainability_score) + 3).toFixed(1);
                
                displayRotationPlan(currentRotationPlan);
                alert('Rotation plan optimized successfully!');
                
            } catch (error) {
                console.error('Error optimizing rotation:', error);
                alert('Error optimizing rotation. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        async function compareScenarios() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            try {
                showLoading(true);
                
                // Generate comparison scenarios
                const scenarios = generateComparisonScenarios();
                displayScenarioComparison(scenarios);
                
                document.getElementById('comparisonSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error comparing scenarios:', error);
                alert('Error comparing scenarios. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        function generateComparisonScenarios() {
            const baseScenario = currentRotationPlan.rotation_sequence.map(item => item.crop);
            
            return [
                {
                    name: 'Current Plan',
                    crops: baseScenario,
                    soil_health: parseFloat(currentRotationPlan.metrics.soil_health_score),
                    profit: parseFloat(currentRotationPlan.metrics.profit_potential.replace(/[$\/acre]/g, '')),
                    risk: currentRotationPlan.metrics.risk_level,
                    sustainability: parseFloat(currentRotationPlan.metrics.sustainability_score)
                },
                {
                    name: 'High Profit Focus',
                    crops: ['Corn', 'Corn', 'Soybeans', 'Wheat'],
                    soil_health: 65.0,
                    profit: 520,
                    risk: 'High',
                    sustainability: 60.0
                },
                {
                    name: 'Soil Health Focus',
                    crops: ['Cover Crops', 'Alfalfa', 'Corn', 'Soybeans'],
                    soil_health: 85.0,
                    profit: 380,
                    risk: 'Low',
                    sustainability: 90.0
                },
                {
                    name: 'Balanced Approach',
                    crops: ['Soybeans', 'Corn', 'Wheat', 'Cover Crops'],
                    soil_health: 75.0,
                    profit: 450,
                    risk: 'Medium',
                    sustainability: 78.0
                }
            ];
        }
        
        function displayScenarioComparison(scenarios) {
            const comparisonTable = document.getElementById('comparisonTable');
            
            let tableHTML = `
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Scenario</th>
                            <th>Rotation Sequence</th>
                            <th>Soil Health</th>
                            <th>Profit Potential</th>
                            <th>Risk Level</th>
                            <th>Sustainability</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            scenarios.forEach((scenario, index) => {
                const isCurrentPlan = index === 0;
                const rowClass = isCurrentPlan ? 'table-primary' : '';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>
                            <strong>${scenario.name}</strong>
                            ${isCurrentPlan ? '<span class="badge bg-primary ms-2">Current</span>' : ''}
                        </td>
                        <td class="small">${scenario.crops.join(' → ')}</td>
                        <td>
                            <span class="metric-value">${scenario.soil_health}%</span>
                        </td>
                        <td>
                            <span class="metric-value">$${scenario.profit}/acre</span>
                        </td>
                        <td>
                            <span class="badge ${getRiskBadgeClass(scenario.risk)}">${scenario.risk}</span>
                        </td>
                        <td>
                            <span class="metric-value">${scenario.sustainability}%</span>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            comparisonTable.innerHTML = tableHTML;
        }
        
        function getRiskBadgeClass(risk) {
            switch(risk.toLowerCase()) {
                case 'low': return 'bg-success';
                case 'medium': return 'bg-warning';
                case 'high': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        async function analyzeBenefits() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            alert('Benefits analysis would show detailed breakdown of environmental, economic, and soil health benefits of your rotation plan.');
        }
        
        async function economicAnalysis() {
            if (!currentRotationPlan) {
                alert('Please generate a rotation plan first');
                return;
            }
            
            alert('Economic analysis would show detailed cost-benefit analysis, cash flow projections, and ROI calculations for your rotation plan.');
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>